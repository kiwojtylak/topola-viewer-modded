{"version":3,"sources":["util/error.ts","util/gedcom_util.ts","util/date_util.ts","datasource/data_source.ts","util/age_util.ts","details/translated-tag.tsx","details/wrapped-image.tsx","details/multiline-text.tsx","details/event-extras.tsx","details/events.tsx","details/details.tsx","datasource/embedded.ts","util/error_i18n.ts","menu/menu_item.tsx","util/media.ts","menu/search_index.ts","menu/search.tsx","menu/upload_menu.tsx","menu/top_bar.tsx","menu/url_menu.tsx","config.tsx","chart.tsx","app.tsx","index.tsx","datasource/load_data.ts"],"names":["TopolaError","code","message","args","Error","pointerToId","pointer","substring","length","idToIndiMap","data","map","Map","indis","forEach","indi","set","id","idToFamMap","fams","fam","prepareGedcom","entries","head","find","entry","tag","other","strcmp","a","b","sortChildren","gedcom","comparator","indiMap","indiId1","indiId2","indi1","get","indi2","compareDates","birth","birthDatesComparator","newFams","children","newChildren","sort","Object","assign","sortFamilyChildren","sortSpouses","famMap","famId1","famId2","fam1","fam2","marriage","marriageDatesComparator","newIndis","sortIndiSpouses","dereference","getterFunction","dereferenced","getData","result","tree","subentry","last","push","normalizeGedcom","IMAGE_EXTENSIONS","isImageFile","fileName","lowerName","toLowerCase","some","ext","endsWith","filterImages","images","newImages","image","filePath","url","replaceAll","match","has","title","startsWith","filterImage","convertGedcom","parseGedcom","json","gedcomEntriesToJson","chartData","getSoftware","sour","name","getName","person","names","filter","subEntry","nameEntry","replace","getFileName","fileEntry","fileTitle","fileExtension","getImageFileEntry","objectEntry","DATE_QUALIFIERS","formatDate","date","intl","hasDay","undefined","day","hasMonth","month","hasYear","year","text","dateObject","toDateObject","formatOptions","formatDateQualifier","qualifier","Intl","DateTimeFormat","locale","format","dateElement","join","lowerCaseQualifier","formatMessage","defaultMessage","formatDateOrRange","dateOrRange","dateRange","fromDate","from","toDate","to","translatedFromDate","translatedToDate","formatDateRage","compareTopolaDates","date1","date2","firstDateOrRange","secondDateOrRange","areDateRangesOverlapped","range1","range2","isValidDateOrRange","isDateRangeClosed","range","Date","DataSourceEnum","formatAgeMoreThan","birthDate","deathDate","ageInYears","calcDateDifferenceInYears","age","formatAgeLessThan","formatAgeBetween","birthDateFrom","birthDateTo","deathDateFrom","deathDateTo","ageInYearsFrom","ageInYearsTo","ageFrom","ageTo","firstDate","secondDate","firstDateObject","secondDateObject","startYear","getUTCFullYear","yearDiff","monthDiff","getUTCMonth","getUTCDate","Math","abs","calcAge","birthGedcomDate","deathGedcomDate","birthDateOrRange","getDate","deathDateOrRange","translatedQualifier","formatExactAge","TAG_DESCRIPTIONS","TranslatedTag","props","normalizedTag","WrappedImage","useState","imageOpen","setImageOpen","imageLoaded","setImageLoaded","imageFailed","setImageFailed","imageSrc","setImageSrc","className","onClick","onLoad","onError","e","currentTarget","alt","src","filename","centered","Placeholder","Image","square","Container","fluid","textAlign","Message","negative","compact","Header","Modal","basic","size","closeIcon","Icon","color","open","onClose","onOpen","Content","label","Label","attached","content","wrapped","MultilineText","lines","line","index","properties","target","eventSources","sources","List","source","Item","verticalAlign","author","publicationInfo","sourceElement","Description","page","EventExtras","useIntl","activeIndex","setActiveIndex","setIndi","handleTabOnClick","event","menuItemProps","panes","menuItem","Menu","fitted","Popup","position","trigger","circular","render","Tab","Pane","notes","note","flatMap","tab","renderActiveOnly","menu","tabular","borderless","PersonLink","location","useLocation","search","queryString","Meta","pathname","EVENT_TAGS","FAMILY_EVENT_TAGS","EventHeader","as","type","sub","getSpouse","familyEntry","spouseReference","familySubEntry","includes","getAge","eventEntry","resolveDate","indiSubEntry","birthEvent","topolaDate","eventPlace","place","eventImages","imageFileEntry","sourceEntryReference","sourceEntry","abbr","sourceData","eventNotes","toEvent","family","familyMarriageEvent","personLink","toFamilyEvents","toIndiEvent","Event","Events","events","event1","event2","EXCLUDED_TAGS","fileDetails","noteDetails","nameDetails","fullName","nameType","getDetails","tags","detailsFunction","element","hasData","getOtherDetails","dataDetails","Details","entriesWithData","Group","divided","EmbeddedMessageType","EmbeddedDataSource","newSource","oldSource","resolve","reject","PARENT_READY","window","parent","postMessage","READY","GEDCOM","loadGedcom","Promise","addEventListener","onMessage","getI18nMessage","error","MenuType","AppMedia","createMedia","breakpoints","small","large","mediaStyles","createMediaStyle","Media","MediaContextProvider","MenuItem","newProps","menuType","Dropdown","require","lunr","normalize","input","toLocaleLowerCase","compare","score","naturalSort","ref","LunrSearchIndex","this","self","initMultiLingualLunrWithoutTrimmer","field","boost","firstName","lastName","spouseLastName","famId","husb","husbId","husband","getHusbandLastName","add","normalizedName","normalizedSpouseLastName","lunrInstance","languages","pipelineFunctions","searchPipelineFunctions","language","unshift","stopWordFilter","stemmer","wordCharacters","pipeline","reset","apply","searchPipeline","query","split","s","slice","getNameLine","trim","SearchBar","searchResults","setSearchResults","searchString","setSearchString","searchIndex","useRef","getDescriptionLine","death","debouncedHandleSearch","debounce","results","current","key","description","displaySearchResult","useEffect","initialize","buildSearchIndex","Search","onSearchChange","_","value","onResultSelect","onSelection","generation","noResultsMessage","placeholder","selectFirstResult","isImageFileName","lower","UploadMenu","history","useHistory","files","filesArray","Array","gedcomFile","file","loadFile","URL","createObjectURL","imageFileNames","keys","hash","md5","state","htmlFor","accept","multiple","onChange","ScreenSize","UrlMenu","dialogOpen","setDialogOpen","setUrl","inputRef","handleLoad","focus","Form","onSubmit","Input","values","link","href","Actions","Button","secondary","primary","TopBar","changeView","view","chartMenus","screenSize","showingChart","chartTypeItems","allowAllRelativesChart","LARGE","eventHandlers","onDownloadPdf","onDownloadPng","onDownloadSvg","SMALL","Divider","fileMenus","standalone","greaterThanOrEqual","inverted","at","icon","ChartColors","Ids","Sex","DEFAULT_CONFIG","COLOR_BY_GENERATION","SHOW","sex","COLOR_ARG","NO_COLOR","COLOR_BY_SEX","COLOR_ARG_INVERSE","v","k","ID_ARG","HIDE","ID_ARG_INVERSE","SEX_ARG","SEX_ARG_INVERSE","argsToConfig","getParam","ConfigPanel","Field","Checkbox","radio","tagName","checked","config","ChartType","zoomed","select","node","scale","transform","offsetX","max","clientWidth","offsetY","clientHeight","attr","scrollLeft","x","scrollTop","y","scrolled","zoomTransform","call","zoom","translateTo","loadAsDataUrl","blob","reader","FileReader","readAsDataURL","onload","inlineImage","baseVal","fetch","response","dataUrl","console","warn","inlineImages","svg","getElementsByTagName","all","loadImage","drawImageOnCanvas","canvas","document","createElement","width","height","ctx","getContext","oldFill","fillStyle","fillRect","drawImage","canvasToBlob","toBlob","getStrippedSvg","getElementById","cloneNode","removeAttribute","setAttribute","String","Number","getAttribute","querySelector","getSvgContentsWithInlinedImages","XMLSerializer","serializeToString","contents","Blob","saveAs","drawOnCanvas","downloadPng","downloadPdf","jspdf","default","doc","orientation","unit","addImage","save","chartColors","TopolaChartColors","getChartType","chartType","Hourglass","HourglassChart","Relatives","RelativesChart","Fancy","FancyChart","getRendererType","CircleRenderer","DetailedRenderer","ChartWrapper","chart","animating","rerenderRequired","zoomBehavior","rerenderProps","rerenderResetPosition","factor","scaleBy","initialRender","resetPosition","freezeAnimation","innerHTML","createChart","renderer","svgSelector","indiCallback","info","colors","animate","updateSvgSize","setData","chartInfo","startIndi","selection","baseGeneration","zoomOutFactor","min","extent","scaleExtent","translateExtent","on","scrollTopTween","i","interpolateNumber","t","scrollLeftTween","dx","origin","dy","svgTransition","transition","delay","duration","tween","animationPromise","then","renderChart","Chart","chartWrapper","prevProps","usePrevious","hideIds","hideSex","AppState","staticUrl","process","REACT_APP_STATIC_URL","ErrorMessage","ErrorPopup","Portal","onDismiss","getArguments","getParamFromSearch","chartTypes","embedded","sourceSpec","GEDCOM_URL","handleCors","UPLOADED","EMBEDDED","parsedGen","isNaN","showSidePanel","messages","cs","messages_cs","de","messages_de","fr","messages_fr","it","messages_it","es","messages_es","pl","messages_pl","ru","messages_ru","navigator","browser","detect","ReactDOM","component","INITIAL","setState","setSelection","setError","setShowSidePanel","setStandalone","setChartType","showErrorPopup","setShowErrorPopup","setSourceSpec","setFreezeAnimation","setConfig","toggleDetails","shouldHideIds","shouldHideSex","hideId","uploadedDataSource","UploadedDataSource","gedcomUrlDataSource","GedcomUrlDataSource","embeddedDataSource","isNewData","newSourceSpec","newSelection","spec","loadData","updateUrl","gen","displayErrorPopup","downloadSvg","onDismissErrorPopup","renderMainArea","SHOWING_CHART","LOADING_MORE","updatedSelection","getSelection","sidePanelTabs","c","configToArgs","Loader","active","ERROR","LOADING","rootElement","classList","remove","exact","path","prepareData","cacheId","serializedData","JSON","stringify","sessionStorage","setItem","loadGedzip","AdmZip","Buffer","arrayBuffer","zip","getEntries","entryName","toString","loadFromUrl","cachedData","getItem","parse","driveUrlMatch1","driveUrlMatch2","urlToFetch","status","statusText"],"mappings":"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","file":"static/js/main.5785c19c.chunk.js","sourcesContent":["/** Error class adding an error code used for i18n. */\nexport class TopolaError extends Error {\n    constructor(\n        public readonly code: string,\n        message: string,\n        public readonly args: { [key: string]: string } = {},\n    ) {\n        super(message);\n    }\n}\n","import {GedcomEntry, parse as parseGedcom} from 'parse-gedcom';\nimport {TopolaError} from './error';\nimport {\n    gedcomEntriesToJson,\n    JsonFam,\n    JsonGedcomData,\n    JsonImage,\n    JsonIndi,\n} from 'topola';\nimport {compareDates} from './date_util';\n\nexport interface GedcomData {\n    /** The HEAD entry. */\n    head: GedcomEntry;\n    /** INDI entries mapped by id. */\n    indis: { [key: string]: GedcomEntry };\n    /** FAM entries mapped by id. */\n    fams: { [key: string]: GedcomEntry };\n    /** Other entries mapped by id, e.g. NOTE, SOUR. */\n    other: { [key: string]: GedcomEntry };\n}\n\nexport interface TopolaData {\n    chartData: JsonGedcomData;\n    gedcom: GedcomData;\n}\n\n/**\n * Returns the identifier extracted from a pointer string.\n * E.g. '@I123@' -> 'I123'\n */\nexport function pointerToId(pointer: string): string {\n    return pointer.substring(1, pointer.length - 1);\n}\n\nexport function idToIndiMap(data: JsonGedcomData): Map<string, JsonIndi> {\n    const map = new Map<string, JsonIndi>();\n    data.indis.forEach((indi) => {\n        map.set(indi.id, indi);\n    });\n    return map;\n}\n\nexport function idToFamMap(data: JsonGedcomData): Map<string, JsonFam> {\n    const map = new Map<string, JsonFam>();\n    data.fams.forEach((fam) => {\n        map.set(fam.id, fam);\n    });\n    return map;\n}\n\nfunction prepareGedcom(entries: GedcomEntry[]): GedcomData {\n    const head = entries.find((entry) => entry.tag === 'HEAD')!;\n    const indis: { [key: string]: GedcomEntry } = {};\n    const fams: { [key: string]: GedcomEntry } = {};\n    const other: { [key: string]: GedcomEntry } = {};\n    entries.forEach((entry) => {\n        if (entry.tag === 'INDI') {\n            indis[pointerToId(entry.pointer)] = entry;\n        } else if (entry.tag === 'FAM') {\n            fams[pointerToId(entry.pointer)] = entry;\n        } else if (entry.pointer) {\n            other[pointerToId(entry.pointer)] = entry;\n        }\n    });\n    return {head, indis, fams, other};\n}\n\nfunction strcmp(a: string, b: string) {\n    if (a < b) {\n        return -1;\n    }\n    if (a > b) {\n        return 1;\n    }\n    return 0;\n}\n\n/** Birth date comparator for individuals. */\nfunction birthDatesComparator(gedcom: JsonGedcomData) {\n    const indiMap = idToIndiMap(gedcom);\n\n    return (indiId1: string, indiId2: string) => {\n        const indi1: JsonIndi | undefined = indiMap.get(indiId1);\n        const indi2: JsonIndi | undefined = indiMap.get(indiId2);\n        return (\n            compareDates(indi1 && indi1.birth, indi2 && indi2.birth) ||\n            strcmp(indiId1, indiId2)\n        );\n    };\n}\n\n/** Marriage date comparator for families. */\nfunction marriageDatesComparator(gedcom: JsonGedcomData) {\n    const famMap = idToFamMap(gedcom);\n\n    return (famId1: string, famId2: string) => {\n        const fam1: JsonFam | undefined = famMap.get(famId1);\n        const fam2: JsonFam | undefined = famMap.get(famId2);\n        return (\n            compareDates(fam1 && fam1.marriage, fam2 && fam2.marriage) ||\n            strcmp(famId1, famId2)\n        );\n    };\n}\n\n/**\n * Sorts children by birth date in the given family.\n * Does not modify the input objects.\n */\nfunction sortFamilyChildren(\n    fam: JsonFam,\n    comparator: (id1: string, id2: string) => number,\n): JsonFam {\n    if (!fam.children) {\n        return fam;\n    }\n    const newChildren = fam.children.sort(comparator);\n    return Object.assign({}, fam, {children: newChildren});\n}\n\n/**\n * Sorts children by birth date.\n * Does not modify the input object.\n */\nfunction sortChildren(gedcom: JsonGedcomData): JsonGedcomData {\n    const comparator = birthDatesComparator(gedcom);\n    const newFams = gedcom.fams.map((fam) => sortFamilyChildren(fam, comparator));\n    return Object.assign({}, gedcom, {fams: newFams});\n}\n\n/**\n * Sorts spouses by marriage date.\n * Does not modify the input objects.\n */\nfunction sortIndiSpouses(\n    indi: JsonIndi,\n    comparator: (id1: string, id2: string) => number,\n): JsonFam {\n    if (!indi.fams) {\n        return indi;\n    }\n    const newFams = indi.fams.sort(comparator);\n    return Object.assign({}, indi, {fams: newFams});\n}\n\nfunction sortSpouses(gedcom: JsonGedcomData): JsonGedcomData {\n    const comparator = marriageDatesComparator(gedcom);\n    const newIndis = gedcom.indis.map((indi) =>\n        sortIndiSpouses(indi, comparator),\n    );\n    return Object.assign({}, gedcom, {indis: newIndis});\n}\n\n/**\n * If the entry is a reference to a top-level entry, the referenced entry is\n * returned. Otherwise, returns the given entry unmodified.\n */\nexport function dereference(\n    entry: GedcomEntry,\n    gedcom: GedcomData,\n    getterFunction: (gedcom: GedcomData) => { [key: string]: GedcomEntry },\n) {\n    if (entry.data) {\n        const dereferenced = getterFunction(gedcom)[pointerToId(entry.data)];\n        if (dereferenced) {\n            return dereferenced;\n        }\n    }\n    return entry;\n}\n\n/**\n * Returns the data for the given GEDCOM entry as an array of lines. Supports\n * continuations with CONT and CONC.\n */\nexport function getData(entry: GedcomEntry) {\n    const result = [entry.data];\n    entry.tree.forEach((subentry) => {\n        if (subentry.tag === 'CONC' && subentry.data) {\n            const last = result.length - 1;\n            result[last] += subentry.data;\n        } else if (subentry.tag === 'CONT' && subentry.data) {\n            result.push(subentry.data);\n        }\n    });\n    return result;\n}\n\n/** Sorts children and spouses. */\nexport function normalizeGedcom(gedcom: JsonGedcomData): JsonGedcomData {\n    return sortSpouses(sortChildren(gedcom));\n}\n\nconst IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif'];\n\n/** Returns true if the given file name has a known image extension. */\nexport function isImageFile(fileName: string): boolean {\n    const lowerName = fileName.toLowerCase();\n    return IMAGE_EXTENSIONS.some((ext) => lowerName.endsWith(ext));\n}\n\n/**\n * Removes images that are not HTTP links or do not have known image extensions.\n * Does not modify the input object.\n */\nfunction filterImage(indi: JsonIndi, images: Map<string, string>): JsonIndi {\n    if (!indi.images || indi.images.length === 0) {\n        return indi;\n    }\n    const newImages: JsonImage[] = [];\n    indi.images.forEach((image) => {\n        const filePath = image.url.replaceAll('\\\\', '/');\n        const fileName = filePath.match(/[^/]*$/)![0];\n        // If the image file has been loaded into memory, use it.\n        if (images.has(filePath)) {\n            newImages.push({url: images.get(filePath)!, title: image.title});\n        } else if (images.has(fileName)) {\n            newImages.push({url: images.get(fileName)!, title: image.title});\n        } else if (image.url.startsWith('http') && isImageFile(image.url)) {\n            newImages.push(image);\n        }\n    });\n    return Object.assign({}, indi, {images: newImages});\n}\n\n/**\n * Removes images that are not HTTP links.\n * Does not modify the input object.\n */\nfunction filterImages(\n    gedcom: JsonGedcomData,\n    images: Map<string, string>,\n): JsonGedcomData {\n    const newIndis = gedcom.indis.map((indi) => filterImage(indi, images));\n    return Object.assign({}, gedcom, {indis: newIndis});\n}\n\n/**\n * Converts GEDCOM file into JSON data performing additional transformations:\n * - sort children by birth date\n * - remove images that are not HTTP links and aren't mapped in `images`.\n *\n * @param images Map from file name to image URL. This is used to pass in\n *   uploaded images.\n */\nexport function convertGedcom(\n    gedcom: string,\n    images: Map<string, string>,\n): TopolaData {\n    const entries = parseGedcom(gedcom);\n    const json = gedcomEntriesToJson(entries);\n    if (\n        !json ||\n        !json.indis ||\n        !json.indis.length ||\n        !json.fams ||\n        !json.fams.length\n    ) {\n        throw new TopolaError('GEDCOM_READ_FAILED', 'Failed to read GEDCOM file');\n    }\n\n    return {\n        chartData: filterImages(normalizeGedcom(json), images),\n        gedcom: prepareGedcom(entries),\n    };\n}\n\nexport function getSoftware(head: GedcomEntry): string | null {\n    const sour =\n        head && head.tree && head.tree.find((entry) => entry.tag === 'SOUR');\n    const name =\n        sour && sour.tree && sour.tree.find((entry) => entry.tag === 'NAME');\n    return (name && name.data) || null;\n}\n\nexport function getName(person: GedcomEntry): string | undefined {\n    const names = person.tree.filter((subEntry) => subEntry.tag === 'NAME');\n    const notMarriedName = names.find(\n        (subEntry) =>\n            subEntry.tree.filter(\n                (nameEntry) => nameEntry.tag === 'TYPE' && nameEntry.data === 'married',\n            ).length === 0,\n    );\n    const name = notMarriedName || names[0];\n    return name?.data.replace(/\\//g, '');\n}\n\nexport function getFileName(fileEntry: GedcomEntry): string | undefined {\n    const fileTitle = fileEntry?.tree.find((entry) => entry.tag === 'TITL')?.data;\n\n    const fileExtension = fileEntry?.tree.find((entry) => entry.tag === 'FORM')\n        ?.data;\n\n    return fileTitle && fileExtension && fileTitle + '.' + fileExtension;\n}\n\nexport function getImageFileEntry(objectEntry: GedcomEntry): GedcomEntry | undefined {\n    return objectEntry.tree.find(\n        (entry) =>\n            entry.tag === 'FILE' &&\n            entry.data.startsWith('http') &&\n            isImageFile(entry.data),\n    );\n}\n","import {Date as TopolaDate, DateOrRange, DateRange, getDate} from 'topola';\nimport {IntlShape} from 'react-intl';\n\nconst DATE_QUALIFIERS = new Map([\n    ['abt', 'about'],\n    ['cal', 'calculated'],\n    ['est', 'estimated'],\n]);\n\nfunction formatDate(date: TopolaDate, intl: IntlShape) {\n    const hasDay = date.day !== undefined;\n    const hasMonth = date.month !== undefined;\n    const hasYear = date.year !== undefined;\n    if (!hasDay && !hasMonth && !hasYear) {\n        return date.text || '';\n    }\n    const dateObject = toDateObject(date);\n    const translatedQualifier = formatDateQualifier(date.qualifier, intl);\n\n    const formatOptions: Intl.DateTimeFormatOptions = {\n        day: hasDay ? 'numeric' : undefined,\n        month: hasMonth ? 'long' : undefined,\n        year: hasYear ? 'numeric' : undefined,\n    };\n    const translatedDate = new Intl.DateTimeFormat(\n        intl.locale,\n        formatOptions,\n    ).format(dateObject);\n\n    return [translatedQualifier, translatedDate]\n        .filter((dateElement) => dateElement)\n        .join(' ');\n}\n\nfunction formatDateRage(dateRange: DateRange, intl: IntlShape) {\n    const fromDate = dateRange.from;\n    const toDate = dateRange.to;\n    const translatedFromDate = fromDate && formatDate(fromDate, intl);\n    const translatedToDate = toDate && formatDate(toDate, intl);\n    if (translatedFromDate && translatedToDate) {\n        return intl.formatMessage(\n            {\n                id: 'date.between',\n                defaultMessage: 'between {from} and {to}',\n            },\n            {from: translatedFromDate, to: translatedToDate},\n        );\n    }\n    if (translatedFromDate) {\n        return intl.formatMessage(\n            {\n                id: 'date.after',\n                defaultMessage: 'after {from}',\n            },\n            {from: translatedFromDate},\n        );\n    }\n    if (translatedToDate) {\n        return intl.formatMessage(\n            {\n                id: 'date.before',\n                defaultMessage: 'before {to}',\n            },\n            {to: translatedToDate},\n        );\n    }\n    return '';\n}\n\nexport function formatDateQualifier(\n    qualifier: string | undefined,\n    intl: IntlShape,\n): string {\n    const lowerCaseQualifier = qualifier && qualifier.toLowerCase();\n    return (\n        (lowerCaseQualifier &&\n            intl.formatMessage({\n                id: `date.${lowerCaseQualifier}`,\n                defaultMessage:\n                    DATE_QUALIFIERS.get(lowerCaseQualifier) || lowerCaseQualifier,\n            })) ||\n        ''\n    );\n}\n\n/** Formats a DateOrRange object. */\nexport function formatDateOrRange(\n    dateOrRange: DateOrRange | undefined,\n    intl: IntlShape,\n): string {\n    if (!dateOrRange) {\n        return '';\n    }\n    if (dateOrRange.date) {\n        return formatDate(dateOrRange.date, intl);\n    }\n    if (dateOrRange.dateRange) {\n        return formatDateRage(dateOrRange.dateRange, intl);\n    }\n    return '';\n}\n\n/** Formats a date given in GEDCOM format. */\nexport function translateDate(gedcomDate: string, intl: IntlShape): string {\n    return formatDateOrRange(getDate(gedcomDate), intl);\n}\n\nexport function compareTopolaDates(\n    date1: TopolaDate | undefined,\n    date2: TopolaDate | undefined,\n): number {\n    if (!date1 || !date1.year || !date2 || !date2.year) {\n        return 0;\n    }\n    if (date1.year !== date2.year) {\n        return date1.year - date2.year;\n    }\n    if (!date1.month || !date2.month) {\n        return 0;\n    }\n    if (date1.month !== date2.month) {\n        return date1.month - date2.month;\n    }\n    if (date1.day && date2.day && date1.day !== date2.day) {\n        return date1.month - date2.month;\n    }\n    return 0;\n}\n\n/** Compares a dates given in GEDCOM format. */\nexport function compareDates(\n    firstDateOrRange: DateOrRange | undefined,\n    secondDateOrRange: DateOrRange | undefined,\n): number {\n    const date1 =\n        firstDateOrRange &&\n        (firstDateOrRange.date ||\n            (firstDateOrRange.dateRange &&\n                (firstDateOrRange.dateRange.from || firstDateOrRange.dateRange.to)));\n    const date2 =\n        secondDateOrRange &&\n        (secondDateOrRange.date ||\n            (secondDateOrRange.dateRange &&\n                (secondDateOrRange.dateRange.from || secondDateOrRange.dateRange.to)));\n    return compareTopolaDates(date1, date2);\n}\n\nexport function areDateRangesOverlapped(\n    range1: DateRange,\n    range2: DateRange,\n): boolean {\n    return (\n        compareTopolaDates(range1.from, range2.to) <= 0 &&\n        compareTopolaDates(range1.to, range2.from) >= 0\n    );\n}\n\nexport function isValidDateOrRange(\n    dateOrRange: DateOrRange | undefined,\n): boolean {\n    // invalid when range is closed and start is before end\n    if (isDateRangeClosed(dateOrRange?.dateRange)) {\n        return (\n            compareTopolaDates(\n                dateOrRange?.dateRange?.from,\n                dateOrRange?.dateRange?.to,\n            ) <= 0\n        );\n    }\n    //valid when there is exact date or date range has start or end defined\n    return !!(\n        dateOrRange?.date ||\n        dateOrRange?.dateRange?.from ||\n        dateOrRange?.dateRange?.to\n    );\n}\n\nexport function isDateRangeClosed(range: DateRange | undefined): boolean {\n    return !!(range?.from && range?.to);\n}\n\nexport function toDateObject(date: TopolaDate): Date {\n    return new Date(\n        date.year !== undefined ? date.year! : 0,\n        date.month !== undefined ? date.month! - 1 : 0,\n        date.day !== undefined ? date.day! : 1,\n    );\n}\n","import {IndiInfo} from 'topola';\nimport {TopolaData} from '../util/gedcom_util';\n\n/** Supported data sources. */\nexport enum DataSourceEnum {\n    UPLOADED,\n    GEDCOM_URL,\n    WIKITREE,\n    EMBEDDED,\n}\n\n/** Source specification together with individual selection. */\nexport interface SourceSelection<SourceSpecT> {\n    spec: SourceSpecT;\n    selection?: IndiInfo;\n}\n\n/** Interface encapsulating functions specific for a data source. */\nexport interface DataSource<SourceSpecT> {\n    /**\n     * Returns true if the application is now loading a completely new data set\n     * and the existing one should be wiped.\n     */\n    isNewData(\n        newSource: SourceSelection<SourceSpecT>,\n        oldSource: SourceSelection<SourceSpecT>,\n        data?: TopolaData,\n    ): boolean;\n\n    /** Loads data from the data source. */\n    loadData(spec: SourceSelection<SourceSpecT>): Promise<TopolaData>;\n}\n","import {Date as TopolaDate} from 'topola/dist/data';\nimport {IntlShape} from 'react-intl';\nimport {DateOrRange, getDate} from 'topola';\nimport {\n    areDateRangesOverlapped,\n    compareDates,\n    formatDateQualifier,\n    isDateRangeClosed,\n    isValidDateOrRange,\n    toDateObject,\n} from './date_util';\n\nfunction formatExactAge(\n    birthDate: TopolaDate,\n    deathDate: TopolaDate,\n    intl: IntlShape,\n): string {\n    const ageInYears = calcDateDifferenceInYears(birthDate, deathDate);\n    const qualifier = birthDate.qualifier || deathDate.qualifier;\n    const translatedQualifier =\n        qualifier && formatDateQualifier(qualifier, intl) + ' ';\n\n    return intl.formatMessage(\n        {\n            id: 'age.exact',\n            defaultMessage:\n                '{qualifier}{age, plural, =0 {Less than 1 year} one {1 year} other {# years}}',\n        },\n        {age: ageInYears, qualifier: translatedQualifier},\n    );\n}\n\nfunction formatAgeMoreThan(\n    birthDate: TopolaDate,\n    deathDate: TopolaDate,\n    intl: IntlShape,\n): string {\n    const ageInYears = calcDateDifferenceInYears(birthDate, deathDate);\n    return intl.formatMessage(\n        {\n            id: 'age.more',\n            defaultMessage:\n                'More than {age, plural, =0 {0 years} one {1 year} other {# years}}',\n        },\n        {age: ageInYears},\n    );\n}\n\nfunction formatAgeLessThan(\n    birthDate: TopolaDate,\n    deathDate: TopolaDate,\n    intl: IntlShape,\n): string {\n    const ageInYears = calcDateDifferenceInYears(birthDate, deathDate);\n    return intl.formatMessage(\n        {\n            id: 'age.less',\n            defaultMessage:\n                'Less than {age, plural, =0 {1 year} one {1 year} other {# years}}',\n        },\n        {age: ageInYears},\n    );\n}\n\nfunction formatAgeBetween(\n    birthDateFrom: TopolaDate,\n    birthDateTo: TopolaDate,\n    deathDateFrom: TopolaDate,\n    deathDateTo: TopolaDate,\n    intl: IntlShape,\n): string {\n    const ageInYearsFrom = calcDateDifferenceInYears(birthDateTo, deathDateFrom);\n    const ageInYearsTo = calcDateDifferenceInYears(birthDateFrom, deathDateTo);\n    return intl.formatMessage(\n        {\n            id: 'age.between',\n            defaultMessage:\n                'Between {ageFrom} and {ageTo, plural, =0 {0 years} one {1 year} other {# years}}',\n        },\n        {ageFrom: ageInYearsFrom, ageTo: ageInYearsTo},\n    );\n}\n\nfunction canCalculateAge(\n    birthDate: DateOrRange | undefined,\n    deathDate: DateOrRange | undefined,\n): boolean {\n    if (birthDate && deathDate) {\n        // cannot calculate if there is no valid birth or death date\n        if (!isValidDateOrRange(birthDate) || !isValidDateOrRange(deathDate)) {\n            return false;\n        }\n        //cannot calculate if death date is before birth date\n        if (compareDates(birthDate, deathDate) > 0) {\n            return false;\n        }\n        // cannot calculate if closed date range for birth or death are overlapping\n        if (\n            birthDate.dateRange &&\n            deathDate.dateRange &&\n            isDateRangeClosed(birthDate?.dateRange) &&\n            isDateRangeClosed(deathDate?.dateRange)\n        ) {\n            return !areDateRangesOverlapped(birthDate.dateRange, deathDate.dateRange);\n        }\n        return true;\n    }\n    return false;\n}\n\nfunction calcDateDifferenceInYears(\n    firstDate: TopolaDate,\n    secondDate: TopolaDate,\n): number {\n    const firstDateObject = toDateObject(firstDate);\n    const secondDateObject = toDateObject(secondDate);\n\n    const startYear = firstDateObject.getUTCFullYear();\n\n    let yearDiff = secondDateObject.getUTCFullYear() - startYear;\n    let monthDiff =\n        secondDateObject.getUTCMonth() - firstDateObject.getUTCMonth();\n    if (monthDiff < 0) {\n        yearDiff--;\n        monthDiff += 12;\n    }\n    const dayDiff = secondDateObject.getUTCDate() - firstDateObject.getUTCDate();\n    if (dayDiff < 0) {\n        if (monthDiff <= 0) {\n            yearDiff--;\n        }\n    }\n    return Math.abs(yearDiff);\n}\n\nexport function calcAge(\n    birthGedcomDate: string | undefined,\n    deathGedcomDate: string | undefined,\n    intl: IntlShape,\n): string | undefined {\n    if (birthGedcomDate && deathGedcomDate) {\n        const birthDateOrRange = getDate(birthGedcomDate);\n        const deathDateOrRange = getDate(deathGedcomDate);\n        if (canCalculateAge(birthDateOrRange, deathDateOrRange)) {\n            if (birthDateOrRange?.date) {\n                if (deathDateOrRange?.date) {\n                    return formatExactAge(\n                        birthDateOrRange.date,\n                        deathDateOrRange.date,\n                        intl,\n                    );\n                }\n                if (\n                    deathDateOrRange?.dateRange?.from &&\n                    deathDateOrRange.dateRange?.to\n                ) {\n                    return formatAgeBetween(\n                        birthDateOrRange.date,\n                        birthDateOrRange.date,\n                        deathDateOrRange?.dateRange?.from,\n                        deathDateOrRange?.dateRange?.to,\n                        intl,\n                    );\n                }\n                if (deathDateOrRange?.dateRange?.from) {\n                    return formatAgeMoreThan(\n                        birthDateOrRange.date,\n                        deathDateOrRange.dateRange?.from,\n                        intl,\n                    );\n                }\n                if (deathDateOrRange?.dateRange?.to) {\n                    return formatAgeLessThan(\n                        birthDateOrRange.date,\n                        deathDateOrRange.dateRange?.to,\n                        intl,\n                    );\n                }\n            }\n            if (\n                birthDateOrRange?.dateRange?.from &&\n                birthDateOrRange?.dateRange?.to\n            ) {\n                if (deathDateOrRange?.date) {\n                    return formatAgeBetween(\n                        birthDateOrRange?.dateRange?.from,\n                        birthDateOrRange?.dateRange?.to,\n                        deathDateOrRange?.date,\n                        deathDateOrRange?.date,\n                        intl,\n                    );\n                }\n                if (\n                    deathDateOrRange?.dateRange?.from &&\n                    deathDateOrRange.dateRange?.to\n                ) {\n                    return formatAgeBetween(\n                        birthDateOrRange?.dateRange?.from,\n                        birthDateOrRange?.dateRange?.to,\n                        deathDateOrRange?.dateRange?.from,\n                        deathDateOrRange?.dateRange?.to,\n                        intl,\n                    );\n                }\n                if (deathDateOrRange?.dateRange?.from) {\n                    return formatAgeMoreThan(\n                        birthDateOrRange.dateRange?.to,\n                        deathDateOrRange.dateRange?.from,\n                        intl,\n                    );\n                }\n                if (deathDateOrRange?.dateRange?.to) {\n                    return formatAgeLessThan(\n                        birthDateOrRange.dateRange?.from,\n                        deathDateOrRange.dateRange?.to,\n                        intl,\n                    );\n                }\n            }\n            if (birthDateOrRange?.dateRange?.from) {\n                if (deathDateOrRange?.date) {\n                    return formatAgeLessThan(\n                        birthDateOrRange.dateRange?.from,\n                        deathDateOrRange.date,\n                        intl,\n                    );\n                }\n                if (deathDateOrRange?.dateRange?.to) {\n                    return formatAgeLessThan(\n                        birthDateOrRange.dateRange?.from,\n                        deathDateOrRange.dateRange?.to,\n                        intl,\n                    );\n                }\n            }\n            if (birthDateOrRange?.dateRange?.to) {\n                if (deathDateOrRange?.date) {\n                    return formatAgeMoreThan(\n                        birthDateOrRange?.dateRange?.to,\n                        deathDateOrRange.date,\n                        intl,\n                    );\n                }\n                if (deathDateOrRange?.dateRange?.from) {\n                    return formatAgeMoreThan(\n                        birthDateOrRange?.dateRange?.to,\n                        deathDateOrRange.dateRange?.from,\n                        intl,\n                    );\n                }\n            }\n        }\n    }\n}\n","import {FormattedMessage} from 'react-intl';\n\nconst TAG_DESCRIPTIONS = new Map([\n    ['ADOP', 'Adoption'],\n    ['BAPM', 'Baptism'],\n    ['BIRT', 'Birth'],\n    ['BURI', 'Burial'],\n    ['CENS', 'Census'],\n    ['CHR', 'Christening'],\n    ['CREM', 'Cremation'],\n    ['DEAT', 'Death'],\n    ['EDUC', 'Education'],\n    ['EMAIL', 'E-mail'],\n    ['EMIG', 'Emigration'],\n    ['EVEN', 'Event'],\n    ['FACT', 'Fact'],\n    ['IMMI', 'Immigration'],\n    ['MARR', 'Marriage'],\n    ['MARS', 'Marriage settlement'],\n    ['ETHN', 'Ethnic'],\n    ['TRIB', 'Tribe'],\n    ['LANG', 'Language'],\n    ['DIV', 'Divorce'],\n    ['MILT', 'Military services'],\n    ['NATU', 'Naturalization'],\n    ['OCCU', 'Occupation'],\n    ['TITL', 'Title'],\n    ['WWW', 'WWW'],\n    ['birth', 'Birth name'],\n    ['married', 'Married name'],\n    ['maiden', 'Maiden name'],\n    ['immigrant', 'Immigrant name'],\n    ['aka', 'Also known as'],\n]);\n\ninterface Props {\n    tag: string;\n}\n\nexport function TranslatedTag(props: Props) {\n    const normalizedTag = props.tag.replace(/_/g, '');\n    return (\n        <FormattedMessage\n            id={`gedcom.${normalizedTag}`}\n            defaultMessage={TAG_DESCRIPTIONS.get(normalizedTag) || normalizedTag}\n        />\n    );\n}\n","import {\n    Container,\n    Icon,\n    Image,\n    Label,\n    Message,\n    Modal,\n    Placeholder,\n} from 'semantic-ui-react';\nimport {SyntheticEvent, useState} from 'react';\nimport {FormattedMessage} from 'react-intl';\n\ninterface Props {\n    url: string;\n    filename: string;\n    title?: string;\n}\n\nexport function WrappedImage(props: Props) {\n    const [imageOpen, setImageOpen] = useState(false);\n    const [imageLoaded, setImageLoaded] = useState(false);\n    const [imageFailed, setImageFailed] = useState(false);\n    const [imageSrc, setImageSrc] = useState('');\n\n    if (imageLoaded && imageSrc !== props.url) {\n        setImageLoaded(false);\n    }\n    return (\n        <>\n            <Image\n                className={imageLoaded ? 'loaded-image-thumbnail' : 'hidden-image'}\n                onClick={() => setImageOpen(true)}\n                onLoad={() => {\n                    setImageLoaded(true);\n                    setImageSrc(props.url);\n                    setImageFailed(false);\n                }}\n                onError={(e: SyntheticEvent<HTMLImageElement, Event>) => {\n                    setImageLoaded(true);\n                    setImageSrc(props.url);\n                    setImageFailed(true);\n                    e.currentTarget.alt = '';\n                }}\n                src={props.url}\n                alt={props.title || props.filename}\n                centered={true}\n            />\n            <Placeholder\n                className={!imageLoaded ? 'image-placeholder' : 'hidden-image'}\n            >\n                <Placeholder.Image square/>\n            </Placeholder>\n            {imageFailed && (\n                <Container fluid textAlign=\"center\">\n                    <Message negative compact>\n                        <Message.Header>\n                            <FormattedMessage\n                                id=\"error.failed_to_load_image\"\n                                defaultMessage={'Failed to load image file'}\n                            />\n                        </Message.Header>\n                    </Message>\n                </Container>\n            )}\n            <Modal\n                basic\n                size=\"large\"\n                closeIcon={<Icon name=\"close\" color=\"red\"/>}\n                open={imageOpen}\n                onClose={() => setImageOpen(false)}\n                onOpen={() => setImageOpen(true)}\n                centered={false}\n            >\n                <Modal.Header>{props.title}</Modal.Header>\n                <Modal.Content image>\n                    <Image\n                        className=\"modal-image\"\n                        src={props.url}\n                        alt={props.title || props.filename}\n                        label={<Label attached=\"bottom\" content={props.filename}/>}\n                        wrapped\n                    />\n                </Modal.Content>\n            </Modal>\n        </>\n    );\n}\n","import Linkify from 'react-linkify';\n\ninterface Props {\n    lines: (JSX.Element | string)[];\n}\n\nexport function MultilineText(props: Props) {\n    return (\n        <>\n            {props.lines.map((line, index) => (\n                <div key={index}>\n                    <Linkify properties={{target: '_blank'}}>{line}</Linkify>\n                    <br/>\n                </div>\n            ))}\n        </>\n    );\n}\n","import {FormattedMessage, IntlShape, useIntl} from 'react-intl';\nimport {\n    Icon,\n    Item,\n    List,\n    Menu,\n    MenuItemProps,\n    Popup,\n    Tab,\n} from 'semantic-ui-react';\nimport {useState} from 'react';\nimport {WrappedImage} from './wrapped-image';\nimport * as React from 'react';\nimport {MultilineText} from './multiline-text';\nimport {DateOrRange} from 'topola';\nimport {formatDateOrRange} from '../util/date_util';\nimport Linkify from 'react-linkify';\n\nexport interface Image {\n    url: string;\n    filename: string;\n    title?: string;\n}\n\nexport interface Source {\n    title?: string;\n    author?: string;\n    page?: string;\n    date?: DateOrRange;\n    publicationInfo?: string;\n}\n\ninterface Props {\n    images?: Image[];\n    notes?: string[][];\n    sources?: Source[];\n    indi: string;\n}\n\nfunction eventImages(images: Image[] | undefined) {\n    return (\n        !!images &&\n        images.map((image, index) => (\n            <List key={index}>\n                <List.Item>\n                    <WrappedImage\n                        url={image.url}\n                        filename={image.filename}\n                        title={image.title}\n                    />\n                </List.Item>\n            </List>\n        ))\n    );\n}\n\nfunction eventNotes(notes: string[][] | undefined) {\n    return (\n        !!notes?.length &&\n        notes.map((note, index) => (\n            <div key={index}>\n                <MultilineText\n                    lines={note.map((line, index) => (\n                        <i key={index}>{line}</i>\n                    ))}\n                />\n            </div>\n        ))\n    );\n}\n\nfunction eventSources(sources: Source[] | undefined, intl: IntlShape) {\n    return (\n        !!sources?.length && (\n            <List>\n                {sources.map((source, index) => (\n                    <List.Item key={index}>\n                        <List.Icon verticalAlign=\"middle\" name=\"circle\" size=\"tiny\"/>\n                        <List.Content>\n                            <List.Header>\n                                <Linkify properties={{target: '_blank'}}>\n                                    {[source.author, source.title, source.publicationInfo]\n                                        .filter((sourceElement) => sourceElement)\n                                        .join(', ')}\n                                </Linkify>\n                            </List.Header>\n                            <List.Description>\n                                <Linkify properties={{target: '_blank'}}>{source.page}</Linkify>\n                                {source.date\n                                    ? ' [' + formatDateOrRange(source.date, intl) + ']'\n                                    : null}\n                            </List.Description>\n                        </List.Content>\n                    </List.Item>\n                ))}\n            </List>\n        )\n    );\n}\n\nexport function EventExtras(props: Props) {\n    const intl = useIntl();\n    const [activeIndex, setActiveIndex] = useState(-1);\n    const [indi, setIndi] = useState('');\n\n    if (!indi || indi !== props.indi) {\n        setActiveIndex(-1);\n        setIndi(props.indi);\n    }\n\n    function handleTabOnClick(\n        event: React.MouseEvent<HTMLAnchorElement>,\n        menuItemProps: MenuItemProps,\n    ) {\n        menuItemProps.index !== undefined && activeIndex !== menuItemProps.index\n            ? setActiveIndex(menuItemProps.index)\n            : setActiveIndex(-1);\n    }\n\n    const imageTab = props.images?.length && {\n        menuItem: (\n            <Menu.Item fitted key=\"images\" onClick={handleTabOnClick}>\n                <Popup\n                    content={\n                        <FormattedMessage id=\"extras.images\" defaultMessage=\"Images\"/>\n                    }\n                    size=\"mini\"\n                    position=\"bottom center\"\n                    trigger={<Icon circular name=\"camera\"/>}\n                />\n            </Menu.Item>\n        ),\n        render: () => <Tab.Pane>{eventImages(props.images)}</Tab.Pane>,\n    };\n\n    const noteTab = props.notes?.length && {\n        menuItem: (\n            <Menu.Item fitted key=\"notes\" onClick={handleTabOnClick}>\n                <Popup\n                    content={\n                        <FormattedMessage id=\"extras.notes\" defaultMessage=\"Notes\"/>\n                    }\n                    size=\"mini\"\n                    position=\"bottom center\"\n                    trigger={<Icon circular name=\"sticky note outline\"/>}\n                />\n            </Menu.Item>\n        ),\n        render: () => <Tab.Pane>{eventNotes(props.notes)}</Tab.Pane>,\n    };\n\n    const sourceTab = props.sources?.length && {\n        menuItem: (\n            <Menu.Item fitted key=\"sources\" onClick={handleTabOnClick}>\n                <Popup\n                    content={\n                        <FormattedMessage id=\"extras.sources\" defaultMessage=\"Sources\"/>\n                    }\n                    size=\"mini\"\n                    position=\"bottom center\"\n                    trigger={<Icon circular name=\"quote right\"/>}\n                />\n            </Menu.Item>\n        ),\n        render: () => <Tab.Pane>{eventSources(props.sources, intl)}</Tab.Pane>,\n    };\n\n    const panes = [imageTab, noteTab, sourceTab].flatMap((tab) =>\n        tab ? [tab] : [],\n    );\n\n    if (panes.length) {\n        return (\n            <Item.Description>\n                <Tab\n                    className=\"event-extras\"\n                    activeIndex={activeIndex}\n                    renderActiveOnly={true}\n                    menu={{\n                        tabular: true,\n                        attached: true,\n                        compact: true,\n                        borderless: true,\n                    }}\n                    panes={panes}\n                />\n            </Item.Description>\n        );\n    }\n    return null;\n}\n","import * as queryString from 'query-string';\nimport flatMap from 'array.prototype.flatmap';\nimport {calcAge} from '../util/age_util';\nimport {compareDates, formatDateOrRange} from '../util/date_util';\nimport {DateOrRange, getDate} from 'topola';\nimport {\n    dereference,\n    GedcomData,\n    getData,\n    getImageFileEntry,\n    getFileName,\n    getName,\n} from '../util/gedcom_util';\nimport {GedcomEntry} from 'parse-gedcom';\nimport {FormattedMessage, IntlShape, useIntl} from 'react-intl';\nimport {Link, useLocation} from 'react-router-dom';\nimport {pointerToId} from '../util/gedcom_util';\nimport {TranslatedTag} from './translated-tag';\nimport {Header, Item} from 'semantic-ui-react';\nimport {EventExtras, Image, Source} from './event-extras';\n\nfunction PersonLink(props: { person: GedcomEntry }) {\n    const location = useLocation();\n\n    const name = getName(props.person);\n\n    const search = queryString.parse(location.search);\n    search['indi'] = pointerToId(props.person.pointer);\n\n    return (\n        <Item.Meta>\n            <Link to={{pathname: '/view', search: queryString.stringify(search)}}>\n                {name ? (\n                    name\n                ) : (\n                    <FormattedMessage id=\"name.unknown_name\" defaultMessage=\"N.N.\"/>\n                )}\n            </Link>\n        </Item.Meta>\n    );\n}\n\ninterface Props {\n    gedcom: GedcomData;\n    indi: string;\n    entries: GedcomEntry[];\n}\n\ninterface EventData {\n    type: string;\n    date?: DateOrRange;\n    age?: string;\n    personLink?: GedcomEntry;\n    place?: string[];\n    images?: Image[];\n    notes?: string[][];\n    sources?: Source[];\n    indi: string;\n}\n\nconst EVENT_TAGS = [\n    'BIRT',\n    'BAPM',\n    'CHR',\n    'FAMS',\n    'EVEN',\n    'CENS',\n    'DEAT',\n    'BURI',\n];\n\nconst FAMILY_EVENT_TAGS = ['MARR', 'MARS', 'DIV'];\n\nfunction EventHeader(props: { event: EventData }) {\n    const intl = useIntl();\n    return (\n        <div className=\"event-header\">\n            <Header as=\"span\" size=\"small\">\n                <TranslatedTag tag={props.event.type}/>\n            </Header>\n            {props.event.date ? (\n                <Header as=\"span\" textAlign=\"right\" sub>\n                    {formatDateOrRange(props.event.date, intl)}\n                </Header>\n            ) : null}\n        </div>\n    );\n}\n\nfunction getSpouse(indi: string, familyEntry: GedcomEntry, gedcom: GedcomData) {\n    const spouseReference = familyEntry.tree\n        .filter((familySubEntry) => ['WIFE', 'HUSB'].includes(familySubEntry.tag))\n        .find((familySubEntry) => !familySubEntry.data.includes(indi));\n\n    if (!spouseReference) {\n        return undefined;\n    }\n    return dereference(spouseReference, gedcom, (gedcom) => gedcom.indis);\n}\n\nfunction getAge(\n    eventEntry: GedcomEntry,\n    indi: string,\n    gedcom: GedcomData,\n    intl: IntlShape,\n): string | undefined {\n    if (eventEntry.tag !== 'DEAT') {\n        return undefined;\n    }\n    const deathDate = resolveDate(eventEntry);\n\n    const birthDate = gedcom.indis[indi].tree\n        .filter((indiSubEntry) => indiSubEntry.tag === 'BIRT')\n        .map((birthEvent) => resolveDate(birthEvent))\n        .find((topolaDate) => topolaDate);\n\n    if (!birthDate || !deathDate) {\n        return undefined;\n    }\n    return calcAge(birthDate?.data, deathDate?.data, intl);\n}\n\nfunction eventPlace(entry: GedcomEntry) {\n    const place = entry.tree.find((subEntry) => subEntry.tag === 'PLAC');\n    return place?.data ? getData(place) : undefined;\n}\n\nfunction eventImages(entry: GedcomEntry, gedcom: GedcomData): Image[] {\n    return entry.tree\n        .filter((subEntry) => 'OBJE' === subEntry.tag)\n        .map((objectEntry) =>\n            dereference(objectEntry, gedcom, (gedcom) => gedcom.other),\n        )\n        .map((objectEntry) => getImageFileEntry(objectEntry))\n        .flatMap((imageFileEntry) =>\n            imageFileEntry\n                ? [\n                    {\n                        url: imageFileEntry?.data || '',\n                        filename: getFileName(imageFileEntry) || '',\n                    },\n                ]\n                : [],\n        );\n}\n\nfunction eventSources(entry: GedcomEntry, gedcom: GedcomData): Source[] {\n    return entry.tree\n        .filter((subEntry) => 'SOUR' === subEntry.tag)\n        .map((sourceEntryReference) => {\n            const sourceEntry = dereference(\n                sourceEntryReference,\n                gedcom,\n                (gedcom) => gedcom.other,\n            );\n\n            const title = sourceEntry.tree.find(\n                (subEntry) => 'TITL' === subEntry.tag,\n            );\n\n            const abbr = sourceEntry.tree.find(\n                (subEntry) => 'ABBR' === subEntry.tag,\n            );\n\n            const author = sourceEntry.tree.find(\n                (subEntry) => 'AUTH' === subEntry.tag,\n            );\n\n            const publicationInfo = sourceEntry.tree.find(\n                (subEntry) => 'PUBL' === subEntry.tag,\n            );\n\n            const page = sourceEntryReference.tree.find(\n                (subEntry) => 'PAGE' === subEntry.tag,\n            );\n\n            const sourceData = sourceEntryReference.tree.find(\n                (subEntry) => 'DATA' === subEntry.tag,\n            );\n\n            const date = sourceData ? resolveDate(sourceData) : undefined;\n\n            return {\n                title: title?.data || abbr?.data,\n                author: author?.data,\n                page: page?.data,\n                date: date ? getDate(date.data) : undefined,\n                publicationInfo: publicationInfo?.data,\n            };\n        });\n}\n\nfunction eventNotes(entry: GedcomEntry, gedcom: GedcomData): string[][] {\n    return entry.tree\n        .filter((subentry) => ['NOTE', 'TYPE'].includes(subentry.tag))\n        .map((note) => dereference(note, gedcom, (gedcom) => gedcom.other))\n        .map((note) => getData(note));\n}\n\nfunction toEvent(\n    entry: GedcomEntry,\n    gedcom: GedcomData,\n    indi: string,\n    intl: IntlShape,\n): EventData[] {\n    if (entry.tag === 'FAMS') {\n        return toFamilyEvents(entry, gedcom, indi);\n    }\n    return toIndiEvent(entry, gedcom, indi, intl);\n}\n\nfunction toIndiEvent(\n    entry: GedcomEntry,\n    gedcom: GedcomData,\n    indi: string,\n    intl: IntlShape,\n): EventData[] {\n    const date = resolveDate(entry) || null;\n    return [\n        {\n            date: date ? getDate(date.data) : undefined,\n            type: entry.tag,\n            age: getAge(entry, indi, gedcom, intl),\n            place: eventPlace(entry),\n            images: eventImages(entry, gedcom),\n            notes: eventNotes(entry, gedcom),\n            sources: eventSources(entry, gedcom),\n            indi: indi,\n        },\n    ];\n}\n\nfunction resolveDate(entry: GedcomEntry) {\n    return entry.tree.find((subEntry) => subEntry.tag === 'DATE');\n}\n\nfunction toFamilyEvents(\n    entry: GedcomEntry,\n    gedcom: GedcomData,\n    indi: string,\n): EventData[] {\n    const family = dereference(entry, gedcom, (gedcom) => gedcom.fams);\n    return flatMap(FAMILY_EVENT_TAGS, (tag) =>\n        family.tree.filter((entry) => entry.tag === tag),\n    ).map((familyMarriageEvent) => {\n        const date = resolveDate(familyMarriageEvent) || null;\n        return {\n            date: date ? getDate(date.data) : undefined,\n            type: familyMarriageEvent.tag,\n            personLink: getSpouse(indi, family, gedcom),\n            place: eventPlace(familyMarriageEvent),\n            images: eventImages(familyMarriageEvent, gedcom),\n            notes: eventNotes(familyMarriageEvent, gedcom),\n            sources: eventSources(familyMarriageEvent, gedcom),\n            indi: indi,\n        };\n    });\n}\n\nfunction Event(props: { event: EventData }) {\n    return (\n        <Item>\n            <Item.Content>\n                <EventHeader event={props.event}/>\n                {!!props.event.age && <Item.Meta>{props.event.age}</Item.Meta>}\n                {!!props.event.personLink && (<PersonLink person={props.event.personLink}/>)}\n                {!!props.event.place && (\n                    <Item.Description>{props.event.place}</Item.Description>\n                )}\n                <EventExtras\n                    images={props.event.images}\n                    notes={props.event.notes}\n                    sources={props.event.sources}\n                    indi={props.event.indi}\n                />\n            </Item.Content>\n        </Item>\n    );\n}\n\nexport function Events(props: Props) {\n    const intl = useIntl();\n\n    const events = flatMap(EVENT_TAGS, (tag) =>\n        props.entries\n            .filter((entry) => entry.tag === tag)\n            .map((eventEntry) => toEvent(eventEntry, props.gedcom, props.indi, intl))\n            .flatMap((events) => events)\n            .sort((event1, event2) => compareDates(event1.date, event2.date)),\n    );\n    if (events.length) {\n        return (\n            <>\n                {events.map((event, index) => (\n                    <Event event={event} key={index}/>\n                ))}\n            </>\n        );\n    }\n    return null;\n}\n","import flatMap from 'array.prototype.flatmap';\nimport {\n    dereference,\n    GedcomData,\n    getData,\n    getFileName,\n    getImageFileEntry\n} from '../util/gedcom_util';\nimport {Events} from './events';\nimport {GedcomEntry} from 'parse-gedcom';\nimport {MultilineText} from './multiline-text';\nimport {TranslatedTag} from './translated-tag';\nimport {Header, Item} from 'semantic-ui-react';\nimport {FormattedMessage} from 'react-intl';\nimport {WrappedImage} from './wrapped-image';\n\nconst EXCLUDED_TAGS = [\n    'BIRT',\n    'BAPM',\n    'CHR',\n    'EVEN',\n    'CENS',\n    'DEAT',\n    'BURI',\n    'NAME',\n    'SEX',\n    'FAMC',\n    'FAMS',\n    'NOTE',\n    'SOUR',\n];\n\nfunction dataDetails(entry: GedcomEntry) {\n    const lines = [];\n    if (entry.data) {\n        lines.push(...getData(entry));\n    }\n    entry.tree\n        .filter((subentry) => subentry.tag === 'NOTE')\n        .forEach((note) =>\n            getData(note).forEach((line) => lines.push(<i>{line}</i>)),\n        );\n    if (!lines.length) {\n        return null;\n    }\n    return (\n        <>\n            <Header sub>\n                <TranslatedTag tag={entry.tag}/>\n            </Header>\n            <span>\n        <MultilineText lines={lines}/>\n      </span>\n        </>\n    );\n}\n\nfunction fileDetails(objectEntry: GedcomEntry) {\n    const imageFileEntry = getImageFileEntry(objectEntry);\n\n    return imageFileEntry ? (\n        <div className=\"person-image\">\n            <WrappedImage\n                url={imageFileEntry.data}\n                filename={getFileName(imageFileEntry) || ''}\n            />\n        </div>\n    ) : null;\n}\n\nfunction noteDetails(entry: GedcomEntry) {\n    return (\n        <MultilineText\n            lines={getData(entry).map((line, index) => (\n                <i key={index}>{line}</i>\n            ))}\n        />\n    );\n}\n\nfunction nameDetails(entry: GedcomEntry) {\n    const fullName = entry.data.replaceAll('/', '');\n\n    const nameType = entry.tree.find(\n        (entry) => entry.tag === 'TYPE' && entry.data !== 'Unknown',\n    )?.data;\n\n    return (\n        <>\n            <Header as=\"span\" size=\"large\">\n                {fullName ? (\n                    fullName\n                ) : (\n                    <FormattedMessage id=\"name.unknown_name\" defaultMessage=\"N.N.\"/>\n                )}\n            </Header>\n            {fullName && nameType && (\n                <Item.Meta>\n                    <TranslatedTag tag={nameType}/>\n                </Item.Meta>\n            )}\n        </>\n    );\n}\n\nfunction getDetails(\n    entries: GedcomEntry[],\n    tags: string[],\n    detailsFunction: (entry: GedcomEntry) => JSX.Element | null,\n): JSX.Element[] {\n    return flatMap(tags, (tag) =>\n        entries\n            .filter((entry) => entry.tag === tag)\n            .map((entry) => detailsFunction(entry)),\n    )\n        .filter((element) => element !== null)\n        .map((element, index) => (\n            <Item key={index}>\n                <Item.Content>{element}</Item.Content>\n            </Item>\n        ));\n}\n\n/**\n * Returns true if there is displayable information in this entry.\n * Returns false if there is no data in this entry or this is only a reference\n * to another entry.\n */\nfunction hasData(entry: GedcomEntry) {\n    return entry.tree.length > 0 || (entry.data && !entry.data.startsWith('@'));\n}\n\nfunction getOtherDetails(entries: GedcomEntry[]) {\n    return entries\n        .filter((entry) => !EXCLUDED_TAGS.includes(entry.tag))\n        .filter(hasData)\n        .map((entry) => dataDetails(entry))\n        .filter((element) => element !== null)\n        .map((element, index) => (\n            <Item key={index}>\n                <Item.Content>{element}</Item.Content>\n            </Item>\n        ));\n}\n\ninterface Props {\n    gedcom: GedcomData;\n    indi: string;\n}\n\nexport function Details(props: Props) {\n    const entries = props.gedcom.indis[props.indi].tree;\n    const entriesWithData = entries\n        .map((entry) => dereference(entry, props.gedcom, (gedcom) => gedcom.other))\n        .filter(hasData);\n\n    return (\n        <div className=\"details\">\n            <Item.Group divided>\n                {getDetails(entries, ['NAME'], nameDetails)}\n                {getDetails(entriesWithData, ['OBJE'], fileDetails)}\n                <Events gedcom={props.gedcom} entries={entries} indi={props.indi}/>\n                {getOtherDetails(entriesWithData)}\n                {getDetails(entriesWithData, ['NOTE'], noteDetails)}\n            </Item.Group>\n        </div>\n    );\n}\n","import {DataSource, DataSourceEnum, SourceSelection} from './data_source';\nimport {TopolaData} from '../util/gedcom_util';\nimport {loadGedcom} from './load_data';\n\n/**\n * Message types used in embedded mode.\n * When the parent is ready to receive messages, it sends PARENT_READY.\n * When the child (this app) is ready to receive messages, it sends READY.\n * When the child receives PARENT_READY, it sends READY.\n * When the parent receives READY, it sends data in a GEDCOM message.\n */\nenum EmbeddedMessageType {\n    GEDCOM = 'gedcom',\n    READY = 'ready',\n    PARENT_READY = 'parent_ready',\n}\n\n/** Message sent to parent or received from parent in embedded mode. */\ninterface EmbeddedMessage {\n    message: EmbeddedMessageType;\n}\n\ninterface GedcomMessage extends EmbeddedMessage {\n    message: EmbeddedMessageType.GEDCOM;\n    gedcom?: string;\n}\n\nexport interface EmbeddedSourceSpec {\n    source: DataSourceEnum.EMBEDDED;\n}\n\n/** GEDCOM file received from outside of the iframe. */\nexport class EmbeddedDataSource implements DataSource<EmbeddedSourceSpec> {\n    isNewData(\n        newSource: SourceSelection<EmbeddedSourceSpec>,\n        oldSource: SourceSelection<EmbeddedSourceSpec>,\n        data?: TopolaData,\n    ): boolean {\n        // Never reload data.\n        return false;\n    }\n\n    private async onMessage(\n        message: EmbeddedMessage,\n        resolve: (value: TopolaData) => void,\n        reject: (reason: any) => void,\n    ) {\n        if (message.message === EmbeddedMessageType.PARENT_READY) {\n            // Parent didn't receive the first 'ready' message, so we need to send it again.\n            window.parent.postMessage({message: EmbeddedMessageType.READY}, '*');\n        } else if (message.message === EmbeddedMessageType.GEDCOM) {\n            const gedcom = (message as GedcomMessage).gedcom;\n            if (!gedcom) {\n                return;\n            }\n            try {\n                const data = await loadGedcom('', gedcom);\n                resolve(data);\n            } catch (error) {\n                reject(error);\n            }\n        }\n    }\n\n    async loadData(source: SourceSelection<EmbeddedSourceSpec>): Promise<TopolaData> {\n        // Notify the parent window that we are ready.\n        return new Promise<TopolaData>((resolve, reject) => {\n            window.parent.postMessage({message: EmbeddedMessageType.READY}, '*');\n            window.addEventListener('message', (data) =>\n                this.onMessage(data.data, resolve, reject),\n            );\n        });\n    }\n}\n","import {IntlShape} from 'react-intl';\nimport {TopolaError} from './error';\n\n/**\n * Returns a translated message for the given error. If the message can't be\n * translated, the original error.message is returned.\n */\nexport function getI18nMessage(error: Error, intl: IntlShape): string {\n    if (!(error instanceof TopolaError)) {\n        return error.message;\n    }\n    return intl.formatMessage(\n        {\n            id: `error.${error.code}`,\n            defaultMessage: error.message,\n        },\n        error.args,\n    );\n}\n","import {\n    Menu,\n    Dropdown,\n    MenuItemProps,\n    DropdownItemProps,\n} from 'semantic-ui-react';\n\nexport enum MenuType {\n    Menu,\n    Dropdown,\n}\n\ninterface Props {\n    menuType?: MenuType;\n}\n\nexport function MenuItem(props: Props & MenuItemProps & DropdownItemProps) {\n    const newProps = {...props};\n    // Remove menuType from props to avoid error message in the console.\n    delete newProps.menuType;\n    return (\n        <>\n            {props.menuType === MenuType.Menu ? (\n                <Menu.Item {...newProps}>{props.children}</Menu.Item>\n            ) : (\n                <Dropdown.Item {...newProps}>{props.children}</Dropdown.Item>\n            )}\n        </>\n    );\n}\n","import {createMedia} from '@artsy/fresnel';\n\n/** Defines the breakpoints at which to show different UI variants.*/\nconst AppMedia = createMedia({\n    breakpoints: {\n        small: 320,\n        large: 768,\n    },\n});\nexport const mediaStyles = AppMedia.createMediaStyle();\nexport const {Media, MediaContextProvider} = AppMedia;\n","import lunr, {PipelineFunction} from 'lunr';\nimport naturalSort from 'javascript-natural-sort';\nimport {idToFamMap, idToIndiMap} from '../util/gedcom_util';\nimport {JsonFam, JsonGedcomData, JsonIndi} from 'topola';\n\n// TODO: Add type declarations and use import instead of require.\nrequire('lunr-languages/lunr.stemmer.support')(lunr);\nrequire('lunr-languages/lunr.de')(lunr);\nrequire('lunr-languages/lunr.fr')(lunr);\nrequire('lunr-languages/lunr.it')(lunr);\nrequire('lunr-languages/lunr.ru')(lunr);\n\nconst MAX_RESULTS = 8;\n\nexport interface SearchResult {\n    id: string;\n    indi: JsonIndi;\n}\n\nexport interface SearchIndex {\n    search(input: string): SearchResult[];\n}\n\n/** Removes accents from letters, e.g. ->o, ->e. */\nfunction normalize(input: string) {\n    return input\n        .toLocaleLowerCase()\n        .normalize('NFD')\n        .replace(/[\\u0300-\\u036f]/g, '')\n        .replace(/\\u0142/g, 'l'); // Special case:  is not affected by NFD.\n}\n\n/** Comparator to sort by score first, then by id. */\nfunction compare(a: lunr.Index.Result, b: lunr.Index.Result) {\n    if (a.score !== b.score) {\n        return b.score - a.score;\n    }\n    return naturalSort(a.ref, b.ref);\n}\n\n/** Returns all last names of all husbands as a space-separated string. */\nfunction getHusbandLastName(\n    indi: JsonIndi,\n    indiMap: Map<String, JsonIndi>,\n    famMap: Map<string, JsonFam>,\n): string {\n    return (indi.fams || [])\n        .map((famId) => famMap.get(famId))\n        .map((fam) => fam && fam.husb)\n        .map((husbId) => husbId && indiMap.get(husbId))\n        .map((husband) => husband && husband.lastName)\n        .join(' ');\n}\n\nclass LunrSearchIndex implements SearchIndex {\n    private index: lunr.Index | undefined;\n    private indiMap: Map<string, JsonIndi>;\n    private famMap: Map<string, JsonFam>;\n\n    constructor(data: JsonGedcomData) {\n        this.indiMap = idToIndiMap(data);\n        this.famMap = idToFamMap(data);\n    }\n\n    initialize() {\n        const self = this;\n        this.index = lunr(function () {\n            //Trimmer will break non-latin characters, so custom multilingual implementation must be used\n            self.initMultiLingualLunrWithoutTrimmer(this, [\n                'de',\n                'en',\n                'fr',\n                'it',\n                'ru',\n            ]);\n            this.ref('id');\n            this.field('id');\n            this.field('name', {boost: 10});\n            this.field('normalizedName', {boost: 8});\n            this.field('spouseLastName', {boost: 2});\n            this.field('normalizedSpouseLastName', {boost: 2});\n\n            self.indiMap.forEach((indi) => {\n                const name = [indi.firstName, indi.lastName].join(' ');\n                const spouseLastName = getHusbandLastName(\n                    indi,\n                    self.indiMap,\n                    self.famMap,\n                );\n                this.add({\n                    id: indi.id,\n                    name,\n                    normalizedName: normalize(name),\n                    spouseLastName,\n                    normalizedSpouseLastName: normalize(spouseLastName),\n                });\n            });\n        });\n    }\n\n    private initMultiLingualLunrWithoutTrimmer(\n        lunrInstance: any,\n        languages: string[],\n    ): void {\n        let wordCharacters = '';\n        const pipelineFunctions: PipelineFunction[] = [];\n        const searchPipelineFunctions: PipelineFunction[] = [];\n        languages.forEach((language) => {\n            if (language === 'en') {\n                wordCharacters += '\\\\w';\n                pipelineFunctions.unshift(lunr.stopWordFilter);\n                pipelineFunctions.push(lunr.stemmer);\n                searchPipelineFunctions.push(lunr.stemmer);\n            } else {\n                wordCharacters += lunr[language].wordCharacters;\n                if (lunr[language].stopWordFilter) {\n                    pipelineFunctions.unshift(lunr[language].stopWordFilter);\n                }\n                if (lunr[language].stemmer) {\n                    pipelineFunctions.push(lunr[language].stemmer);\n                    searchPipelineFunctions.push(lunr[language].stemmer);\n                }\n            }\n        });\n        lunrInstance.pipeline.reset();\n        lunrInstance.pipeline.add.apply(lunrInstance.pipeline, pipelineFunctions);\n\n        if (lunrInstance.searchPipeline) {\n            lunrInstance.searchPipeline.reset();\n            lunrInstance.searchPipeline.add.apply(\n                lunrInstance.searchPipeline,\n                searchPipelineFunctions,\n            );\n        }\n    }\n\n    public search(input: string): SearchResult[] {\n        const query = input\n            .split(' ')\n            .filter((s) => !!s)\n            .map((s) => `${s} ${s}*`)\n            .join(' ');\n        const results = this.index!.search(query);\n        return results\n            .sort(compare)\n            .slice(0, MAX_RESULTS)\n            .map((result) => ({id: result.ref, indi: this.indiMap.get(result.ref)!}));\n    }\n}\n\n/** Builds a search index from data. */\nexport function buildSearchIndex(data: JsonGedcomData): SearchIndex {\n    const index = new LunrSearchIndex(data);\n    index.initialize();\n    return index;\n}\n","import debounce from 'debounce';\nimport {buildSearchIndex, SearchIndex, SearchResult} from './search_index';\nimport {formatDateOrRange} from '../util/date_util';\nimport {IndiInfo, JsonGedcomData} from 'topola';\nimport {JsonIndi} from 'topola';\nimport {Search, SearchResultProps} from 'semantic-ui-react';\nimport {useEffect, useRef, useState} from 'react';\nimport {useIntl} from 'react-intl';\n\nfunction getNameLine(result: SearchResult) {\n    const name = [result.indi.firstName, result.indi.lastName].join(' ').trim();\n    if (result.id.length > 8) {\n        return name;\n    }\n    return (\n        <>\n            {name} <i>({result.id})</i>\n        </>\n    );\n}\n\ninterface Props {\n    /** Data used for the search index. */\n    data: JsonGedcomData;\n    onSelection: (indiInfo: IndiInfo) => void;\n}\n\n/** Displays and handles the search box in the top bar. */\nexport function SearchBar(props: Props) {\n    const [searchResults, setSearchResults] = useState<SearchResultProps[]>([]);\n    const [searchString, setSearchString] = useState('');\n    const searchIndex = useRef<SearchIndex>();\n    const intl = useIntl();\n\n    function getDescriptionLine(indi: JsonIndi) {\n        const birthDate = formatDateOrRange(indi.birth, intl);\n        const deathDate = formatDateOrRange(indi.death, intl);\n        if (!deathDate) {\n            return birthDate;\n        }\n        return `${birthDate}  ${deathDate}`;\n    }\n\n    /** Produces an object that is displayed in the Semantic UI Search results. */\n    function displaySearchResult(result: SearchResult): SearchResultProps {\n        return {\n            id: result.id,\n            key: result.id,\n            title: getNameLine(result),\n            description: getDescriptionLine(result.indi),\n        } as SearchResultProps;\n    }\n\n    /** On search input change. */\n    function handleSearch(input: string | undefined) {\n        if (!input) {\n            return;\n        }\n        const results = searchIndex\n            .current!.search(input)\n            .map((result) => displaySearchResult(result));\n        setSearchResults(results);\n    }\n\n    const debouncedHandleSearch = useRef(debounce(handleSearch, 200));\n\n    /** On search result selected. */\n    function handleResultSelect(id: string) {\n        // analyticsEvent('search_result_selected');\n        props.onSelection({id, generation: 0});\n        setSearchString('');\n    }\n\n    /** On search string changed. */\n    function onChange(value: string) {\n        debouncedHandleSearch.current(value);\n        setSearchString(value);\n    }\n\n    // Initialize the search index.\n    useEffect(() => {\n        searchIndex.current = buildSearchIndex(props.data);\n    }, [props.data]);\n\n    return (\n        <Search\n            onSearchChange={(_, data) => onChange(data.value!)}\n            onResultSelect={(_, data) => handleResultSelect(data.result.id)}\n            results={searchResults}\n            noResultsMessage={intl.formatMessage({\n                id: 'menu.search.no_results',\n                defaultMessage: 'No results found',\n            })}\n            placeholder={intl.formatMessage({\n                id: 'menu.search.placeholder',\n                defaultMessage: 'Search for people',\n            })}\n            selectFirstResult={true}\n            value={searchString}\n            id=\"search\"\n        />\n    );\n}\n","import * as queryString from 'query-string';\nimport md5 from 'md5';\nimport {Dropdown, Icon, Menu} from 'semantic-ui-react';\nimport {FormattedMessage} from 'react-intl';\nimport {MenuType} from './menu_item';\nimport {SyntheticEvent} from 'react';\nimport {useHistory, useLocation} from 'react-router';\nimport {loadFile} from '../datasource/load_data';\n\nfunction isImageFileName(fileName: string) {\n    const lower = fileName.toLowerCase();\n    return lower.endsWith('.jpg') || lower.endsWith('.png');\n}\n\ninterface Props {\n    menuType: MenuType;\n}\n\n/** Displays and handles the \"Open file\" menu. */\nexport function UploadMenu(props: Props) {\n    const history = useHistory();\n    const location = useLocation();\n\n    async function handleUpload(event: SyntheticEvent<HTMLInputElement>) {\n        const files = (event.target as HTMLInputElement).files;\n        if (!files || !files.length) {\n            return;\n        }\n        const filesArray = Array.from(files);\n        (event.target as HTMLInputElement).value = ''; // Reset the file input.\n\n        const gedcomFile =\n            filesArray.length === 1\n                ? filesArray[0]\n                : filesArray.find((file) => file.name.toLowerCase().endsWith('.ged')) ||\n                filesArray[0];\n        const {gedcom, images} = await loadFile(gedcomFile);\n\n        // Convert uploaded images to object URLs.\n        filesArray\n            .filter(\n                (file) => file.name !== gedcomFile.name && isImageFileName(file.name),\n            )\n            .forEach((file) => images.set(file.name, URL.createObjectURL(file)));\n\n        // Hash GEDCOM contents with uploaded image file names.\n        const imageFileNames = Array.from(images.keys()).sort().join('|');\n        const hash = md5(md5(gedcom) + imageFileNames);\n\n        // Use history.replace() when re-uploading the same file and history.push() when loading a new file.\n        const search = queryString.parse(location.search);\n        const historyPush = search.file === hash ? history.replace : history.push;\n\n        historyPush({\n            pathname: '/view',\n            search: queryString.stringify({file: hash}),\n            state: {data: gedcom, images},\n        });\n    }\n\n    const content = (\n        <>\n            <Icon name=\"folder open\"/>\n            <FormattedMessage id=\"menu.open_file\" defaultMessage=\"Open file\"/>\n        </>\n    );\n    return (\n        <>\n            {props.menuType === MenuType.Menu ? (\n                <label htmlFor=\"fileInput\">\n                    <Menu.Item as=\"a\">{content}</Menu.Item>\n                </label>\n            ) : (\n                <Dropdown.Item as=\"label\" htmlFor=\"fileInput\">\n                    {content}\n                </Dropdown.Item>\n            )}\n            <input\n                className=\"hidden\"\n                type=\"file\"\n                accept=\".ged,.gdz,.gedzip,.zip,image/*\"\n                id=\"fileInput\"\n                multiple\n                onChange={handleUpload}\n            />\n        </>\n    );\n}\n","import * as queryString from 'query-string';\nimport {Dropdown, Icon, Menu} from 'semantic-ui-react';\nimport {FormattedMessage} from 'react-intl';\nimport {IndiInfo, JsonGedcomData} from 'topola';\nimport {Media} from '../util/media';\nimport {MenuType} from './menu_item';\nimport {SearchBar} from './search';\nimport {UploadMenu} from './upload_menu';\nimport {UrlMenu} from './url_menu';\nimport {useHistory, useLocation} from 'react-router';\n\nenum ScreenSize {\n    LARGE,\n    SMALL,\n}\n\ninterface EventHandlers {\n    onSelection: (indiInfo: IndiInfo) => void;\n    onDownloadPdf: () => void;\n    onDownloadPng: () => void;\n    onDownloadSvg: () => void;\n}\n\ninterface Props {\n    /** True if the application is currently showing a chart. */\n    showingChart: boolean;\n    /** Data used for the search index. */\n    data?: JsonGedcomData;\n    standalone: boolean;\n    /** Whether to show the \"All relatives\" chart type in the menu. */\n    allowAllRelativesChart: boolean;\n    eventHandlers: EventHandlers;\n}\n\nexport function TopBar(props: Props) {\n    const history = useHistory();\n    const location = useLocation();\n\n    function changeView(view: string) {\n        const search = queryString.parse(location.search);\n        if (search.view !== view) {\n            search.view = view;\n            location.search = queryString.stringify(search);\n            history.push(location);\n        }\n    }\n\n    function chartMenus(screenSize: ScreenSize) {\n        if (!props.showingChart) {\n            return null;\n        }\n        const chartTypeItems = (\n            <>\n                <Dropdown.Item onClick={() => changeView('hourglass')}>\n                    <Icon name=\"hourglass\"/>\n                    <FormattedMessage\n                        id=\"menu.hourglass\"\n                        defaultMessage=\"Hourglass chart\"\n                    />\n                </Dropdown.Item>\n                {props.allowAllRelativesChart ? (\n                    <Dropdown.Item onClick={() => changeView('relatives')}>\n                        <Icon name=\"users\"/>\n                        <FormattedMessage\n                            id=\"menu.relatives\"\n                            defaultMessage=\"All relatives\"\n                        />\n                    </Dropdown.Item>\n                ) : null}\n            </>\n        );\n        switch (screenSize) {\n            case ScreenSize.LARGE:\n                return (\n                    <>\n                        <Dropdown\n                            trigger={\n                                <div>\n                                    <Icon name=\"download\"/>\n                                    <FormattedMessage\n                                        id=\"menu.download\"\n                                        defaultMessage=\"Download\"\n                                    />\n                                </div>\n                            }\n                            className=\"item\"\n                        >\n                            <Dropdown.Menu>\n                                <Dropdown.Item onClick={props.eventHandlers.onDownloadPdf}>\n                                    <FormattedMessage\n                                        id=\"menu.pdf_file\"\n                                        defaultMessage=\"PDF file\"\n                                    />\n                                </Dropdown.Item>\n                                <Dropdown.Item onClick={props.eventHandlers.onDownloadPng}>\n                                    <FormattedMessage\n                                        id=\"menu.png_file\"\n                                        defaultMessage=\"PNG file\"\n                                    />\n                                </Dropdown.Item>\n                                <Dropdown.Item onClick={props.eventHandlers.onDownloadSvg}>\n                                    <FormattedMessage\n                                        id=\"menu.svg_file\"\n                                        defaultMessage=\"SVG file\"\n                                    />\n                                </Dropdown.Item>\n                            </Dropdown.Menu>\n                        </Dropdown>\n\n                        <Dropdown\n                            trigger={\n                                <div>\n                                    <Icon name=\"eye\"/>\n                                    <FormattedMessage id=\"menu.view\" defaultMessage=\"View\"/>\n                                </div>\n                            }\n                            className=\"item\"\n                        >\n                            <Dropdown.Menu>{chartTypeItems}</Dropdown.Menu>\n                        </Dropdown>\n                        <SearchBar\n                            data={props.data!}\n                            onSelection={props.eventHandlers.onSelection}\n                            {...props}\n                        />\n                    </>\n                );\n\n            case ScreenSize.SMALL:\n                return (\n                    <>\n                        <Dropdown.Item onClick={props.eventHandlers.onDownloadPdf}>\n                            <Icon name=\"download\"/>\n                            <FormattedMessage\n                                id=\"menu.download_pdf\"\n                                defaultMessage=\"Download PDF\"\n                            />\n                        </Dropdown.Item>\n                        <Dropdown.Item onClick={props.eventHandlers.onDownloadPng}>\n                            <Icon name=\"download\"/>\n                            <FormattedMessage\n                                id=\"menu.download_png\"\n                                defaultMessage=\"Download PNG\"\n                            />\n                        </Dropdown.Item>\n                        <Dropdown.Item onClick={props.eventHandlers.onDownloadSvg}>\n                            <Icon name=\"download\"/>\n                            <FormattedMessage\n                                id=\"menu.download_svg\"\n                                defaultMessage=\"Download SVG\"\n                            />\n                        </Dropdown.Item>\n\n                        <Dropdown.Divider/>\n                        {chartTypeItems}\n                        <Dropdown.Divider/>\n                    </>\n                );\n        }\n    }\n\n    function fileMenus(screenSize: ScreenSize) {\n        // Don't show \"open\" menus in non-standalone mode.\n        if (!props.standalone) {\n            return null;\n        }\n\n        switch (screenSize) {\n            case ScreenSize.LARGE:\n                // Show dropdown if chart is shown, otherwise show individual menu items.\n                const menus = props.showingChart ? (\n                    <Dropdown\n                        trigger={\n                            <div>\n                                <Icon name=\"folder open\"/>\n                                <FormattedMessage id=\"menu.open\" defaultMessage=\"Open\"/>\n                            </div>\n                        }\n                        className=\"item\"\n                    >\n                        <Dropdown.Menu>\n                            <UploadMenu menuType={MenuType.Dropdown} {...props} />\n                            <UrlMenu menuType={MenuType.Dropdown} {...props} />\n                        </Dropdown.Menu>\n                    </Dropdown>\n                ) : (\n                    <>\n                        <UploadMenu menuType={MenuType.Menu} {...props} />\n                        <UrlMenu menuType={MenuType.Menu} {...props} />\n                    </>\n                );\n                return menus;\n\n            case ScreenSize.SMALL:\n                return (\n                    <>\n                        <UploadMenu menuType={MenuType.Dropdown} {...props} />\n                        <UrlMenu menuType={MenuType.Dropdown} {...props} />\n                        <Dropdown.Divider/>\n                    </>\n                );\n        }\n    }\n\n    function mobileMenus() {\n        return (\n            <>\n                <Dropdown\n                    trigger={\n                        <div>\n                            <Icon name=\"sidebar\"/>\n                        </div>\n                    }\n                    className=\"item\"\n                    icon={null}\n                >\n                    <Dropdown.Menu>\n                        {fileMenus(ScreenSize.SMALL)}\n                        {chartMenus(ScreenSize.SMALL)}\n                    </Dropdown.Menu>\n                </Dropdown>\n            </>\n        );\n    }\n\n    function desktopMenus() {\n        return (\n            <>\n                {fileMenus(ScreenSize.LARGE)}\n                {chartMenus(ScreenSize.LARGE)}\n            </>\n        );\n    }\n\n    return (\n        <>\n            <Menu\n                as={Media}\n                greaterThanOrEqual=\"large\"\n                attached=\"top\"\n                inverted\n                color=\"blue\"\n                size=\"large\"\n            >\n                {desktopMenus()}\n            </Menu>\n            <Menu\n                as={Media}\n                at=\"small\"\n                attached=\"top\"\n                inverted\n                color=\"blue\"\n                size=\"large\"\n            >\n                {mobileMenus()}\n            </Menu>\n        </>\n    );\n}\n","import * as queryString from 'query-string';\nimport {Button, Form, Header, Icon, Input, Modal} from 'semantic-ui-react';\nimport {FormattedMessage} from 'react-intl';\nimport {MenuItem, MenuType} from './menu_item';\nimport {useEffect, useRef, useState} from 'react';\nimport {useHistory} from 'react-router';\n\ninterface Props {\n    menuType: MenuType;\n}\n\n/** Displays and handles the \"Open URL\" menu. */\nexport function UrlMenu(props: Props) {\n    const [dialogOpen, setDialogOpen] = useState(false);\n    const [url, setUrl] = useState('');\n    const inputRef = useRef<Input>(null);\n    const history = useHistory();\n\n    useEffect(() => {\n        if (dialogOpen) {\n            setUrl('');\n            inputRef.current!.focus();\n        }\n    }, [dialogOpen]);\n\n    /** Load button clicked in the \"Load from URL\" dialog. */\n    function handleLoad() {\n        setDialogOpen(false);\n        if (url) {\n            // analyticsEvent('url_selected');\n            history.push({\n                pathname: '/view',\n                search: queryString.stringify({url}),\n            });\n        }\n    }\n\n    function loadFromUrlModal() {\n        return (\n            <Modal\n                open={dialogOpen}\n                onClose={() => setDialogOpen(false)}\n                centered={false}\n            >\n                <Header>\n                    <Icon name=\"cloud download\"/>\n                    <FormattedMessage\n                        id=\"load_from_url.title\"\n                        defaultMessage=\"Load from URL\"\n                    />\n                </Header>\n                <Modal.Content>\n                    <Form onSubmit={handleLoad}>\n                        <Input\n                            placeholder=\"https://\"\n                            fluid\n                            value={url}\n                            onChange={(_, data) => setUrl(data.value)}\n                            ref={inputRef}\n                        />\n                        <p>\n                            <FormattedMessage\n                                id=\"load_from_url.comment\"\n                                defaultMessage={\n                                    'Data from the URL will be loaded through {link} to avoid CORS issues.'\n                                }\n                                values={{\n                                    link: (\n                                        <a href=\"https://topolaproxy.bieda.it/\">\n                                            topolaproxy.bieda.it (cors-anywhere proxy)\n                                        </a>\n                                    ),\n                                }}\n                            />\n                        </p>\n                    </Form>\n                </Modal.Content>\n                <Modal.Actions>\n                    <Button secondary onClick={() => setDialogOpen(false)}>\n                        <FormattedMessage\n                            id=\"load_from_url.cancel\"\n                            defaultMessage=\"Cancel\"\n                        />\n                    </Button>\n                    <Button primary onClick={handleLoad}>\n                        <FormattedMessage id=\"load_from_url.load\" defaultMessage=\"Load\"/>\n                    </Button>\n                </Modal.Actions>\n            </Modal>\n        );\n    }\n\n    return (\n        <>\n            <MenuItem onClick={() => setDialogOpen(true)} menuType={props.menuType}>\n                <Icon name=\"cloud download\"/>\n                <FormattedMessage\n                    id=\"menu.load_from_url\"\n                    defaultMessage=\"Load from URL\"\n                />\n            </MenuItem>\n            {loadFromUrlModal()}\n        </>\n    );\n}\n","import {Item, Checkbox, Form, Header} from 'semantic-ui-react';\nimport {FormattedMessage} from 'react-intl';\nimport {ParsedQuery} from 'query-string';\n\nexport enum ChartColors {\n    NO_COLOR,\n    COLOR_BY_SEX,\n    COLOR_BY_GENERATION,\n}\n\nexport enum Ids {\n    HIDE,\n    SHOW,\n}\n\nexport enum Sex {\n    HIDE,\n    SHOW,\n}\n\nexport interface Config {\n    color: ChartColors;\n    id: Ids;\n    sex: Sex;\n}\n\nexport const DEFAULT_CONFIG: Config = {\n    color: ChartColors.COLOR_BY_GENERATION,\n    id: Ids.SHOW,\n    sex: Sex.SHOW,\n};\n\nconst COLOR_ARG = new Map<string, ChartColors>([\n    ['n', ChartColors.NO_COLOR],\n    ['g', ChartColors.COLOR_BY_GENERATION],\n    ['s', ChartColors.COLOR_BY_SEX],\n]);\nconst COLOR_ARG_INVERSE = new Map<ChartColors, string>();\nCOLOR_ARG.forEach((v, k) => COLOR_ARG_INVERSE.set(v, k));\n\nconst ID_ARG = new Map<string, Ids>([\n    ['h', Ids.HIDE],\n    ['s', Ids.SHOW],\n]);\nconst ID_ARG_INVERSE = new Map<Ids, string>();\nID_ARG.forEach((v, k) => ID_ARG_INVERSE.set(v, k));\n\nconst SEX_ARG = new Map<string, Sex>([\n    ['h', Sex.HIDE],\n    ['s', Sex.SHOW],\n]);\nconst SEX_ARG_INVERSE = new Map<Sex, string>();\nSEX_ARG.forEach((v, k) => SEX_ARG_INVERSE.set(v, k));\n\nexport function argsToConfig(args: ParsedQuery<any>): Config {\n    const getParam = (name: string) => {\n        const value = args[name];\n        return typeof value === 'string' ? value : undefined;\n    };\n\n    return {\n        color: COLOR_ARG.get(getParam('c') ?? '') ?? DEFAULT_CONFIG.color,\n        id: ID_ARG.get(getParam('i') ?? '') ?? DEFAULT_CONFIG.id,\n        sex: SEX_ARG.get(getParam('s') ?? '') ?? DEFAULT_CONFIG.sex,\n    };\n}\n\nexport function configToArgs(config: Config): ParsedQuery<any> {\n    return {\n        c: COLOR_ARG_INVERSE.get(config.color),\n        i: ID_ARG_INVERSE.get(config.id),\n        s: SEX_ARG_INVERSE.get(config.sex),\n    };\n}\n\nexport function ConfigPanel(props: {\n    config: Config;\n    onChange: (config: Config) => void;\n}) {\n    return (\n        <Form className=\"details\">\n            <Item.Group>\n                <Item>\n                    <Item.Content>\n                        <Header sub>\n                            <FormattedMessage id=\"config.colors\" defaultMessage=\"Colors\"/>\n                        </Header>\n                        <Form.Field className=\"no-margin\">\n                            <Checkbox\n                                radio\n                                label={\n                                    <FormattedMessage tagName=\"label\" id=\"config.colors.NO_COLOR\" defaultMessage=\"none\"/>\n                                }\n                                name=\"checkboxRadioGroup\"\n                                value=\"none\"\n                                checked={props.config.color === ChartColors.NO_COLOR}\n                                onClick={() =>\n                                    props.onChange({...props.config, color: ChartColors.NO_COLOR})\n                                }\n                            />\n                        </Form.Field>\n                        <Form.Field className=\"no-margin\">\n                            <Checkbox\n                                radio\n                                label={\n                                    <FormattedMessage tagName=\"label\" id=\"config.colors.COLOR_BY_GENERATION\" defaultMessage=\"by generation\"/>\n                                }\n                                name=\"checkboxRadioGroup\"\n                                value=\"generation\"\n                                checked={props.config.color === ChartColors.COLOR_BY_GENERATION}\n                                onClick={() =>\n                                    props.onChange({...props.config, color: ChartColors.COLOR_BY_GENERATION})\n                                }\n                            />\n                        </Form.Field>\n                        <Form.Field className=\"no-margin\">\n                            <Checkbox\n                                radio\n                                label={\n                                    <FormattedMessage tagName=\"label\" id=\"config.colors.COLOR_BY_SEX\" defaultMessage=\"by sex\"/>\n                                }\n                                name=\"checkboxRadioGroup\"\n                                value=\"gender\"\n                                checked={props.config.color === ChartColors.COLOR_BY_SEX}\n                                onClick={() =>\n                                    props.onChange({...props.config, color: ChartColors.COLOR_BY_SEX})\n                                }\n                            />\n                        </Form.Field>\n                    </Item.Content>\n                </Item>\n                <Item>\n                    <Item.Content>\n                        <Header sub>\n                            <FormattedMessage id=\"config.ids\" defaultMessage=\"IDs\"/>\n                        </Header>\n                        <Form.Field className=\"no-margin\">\n                            <Checkbox\n                                radio\n                                label={\n                                    <FormattedMessage tagName=\"label\" id=\"config.ids.HIDE\" defaultMessage=\"hide\"/>\n                                }\n                                name=\"checkboxRadioGroup\"\n                                value=\"hide\"\n                                checked={props.config.id === Ids.HIDE}\n                                onClick={() =>\n                                    props.onChange({...props.config, id: Ids.HIDE})\n                                }\n                            />\n                        </Form.Field>\n                        <Form.Field className=\"no-margin\">\n                            <Checkbox\n                                radio\n                                label={\n                                    <FormattedMessage tagName=\"label\" id=\"config.ids.SHOW\" defaultMessage=\"show\"/>\n                                }\n                                name=\"checkboxRadioGroup\"\n                                value=\"show\"\n                                checked={props.config.id === Ids.SHOW}\n                                onClick={() =>\n                                    props.onChange({...props.config, id: Ids.SHOW})\n                                }\n                            />\n                        </Form.Field>\n                    </Item.Content>\n                </Item>\n                <Item>\n                    <Item.Content>\n                        <Header sub>\n                            <FormattedMessage id=\"config.sex\" defaultMessage=\"Sex\"/>\n                        </Header>\n                        <Form.Field className=\"no-margin\">\n                            <Checkbox\n                                radio\n                                label={\n                                    <FormattedMessage tagName=\"label\" id=\"config.sex.HIDE\" defaultMessage=\"hide\"/>\n                                }\n                                name=\"checkboxRadioGroup\"\n                                value=\"hide\"\n                                checked={props.config.sex === Sex.HIDE}\n                                onClick={() =>\n                                    props.onChange({...props.config, sex: Sex.HIDE})\n                                }\n                            />\n                        </Form.Field>\n                        <Form.Field className=\"no-margin\">\n                            <Checkbox\n                                radio\n                                label={\n                                    <FormattedMessage tagName=\"label\" id=\"config.sex.SHOW\" defaultMessage=\"show\"/>\n                                }\n                                name=\"checkboxRadioGroup\"\n                                value=\"show\"\n                                checked={props.config.sex === Sex.SHOW}\n                                onClick={() =>\n                                    props.onChange({...props.config, sex: Sex.SHOW})\n                                }\n                            />\n                        </Form.Field>\n                    </Item.Content>\n                </Item>\n            </Item.Group>\n        </Form>\n    );\n}\n","import {ChartColors, Ids, Sex} from './config';\nimport {interpolateNumber} from 'd3-interpolate';\nimport {IntlShape, useIntl} from 'react-intl';\nimport {max, min} from 'd3-array';\nimport {Media} from './util/media';\nimport {saveAs} from 'file-saver';\nimport {select, Selection} from 'd3-selection';\nimport {useEffect, useRef} from 'react';\nimport 'd3-transition';\nimport {\n    D3ZoomEvent,\n    zoom,\n    ZoomBehavior,\n    ZoomedElementBaseType,\n    zoomTransform,\n} from 'd3-zoom';\nimport {\n    JsonGedcomData,\n    ChartHandle,\n    IndiInfo,\n    createChart,\n    DetailedRenderer,\n    HourglassChart,\n    RelativesChart,\n    FancyChart,\n    CircleRenderer,\n    ChartColors as TopolaChartColors,\n} from 'topola';\n\n/** How much to zoom when using the +/- buttons. */\nconst ZOOM_FACTOR = 1.3;\n\n/**\n * Called when the view is dragged with the mouse.\n *\n * @param size the size of the chart\n */\nfunction zoomed(\n    size: [number, number],\n    event: D3ZoomEvent<ZoomedElementBaseType, unknown>,\n) {\n    const parent = select('#svgContainer').node() as Element;\n\n    const scale = event.transform.k;\n    const offsetX = max([0, (parent.clientWidth - size[0] * scale) / 2]);\n    const offsetY = max([0, (parent.clientHeight - size[1] * scale) / 2]);\n    select('#chartSvg')\n        .attr('width', size[0] * scale)\n        .attr('height', size[1] * scale)\n        .attr('transform', `translate(${offsetX}, ${offsetY})`);\n    select('#chart').attr('transform', `scale(${scale})`);\n    parent.scrollLeft = -event.transform.x;\n    parent.scrollTop = -event.transform.y;\n}\n\n/** Called when the scrollbars are used. */\nfunction scrolled() {\n    const parent = select('#svgContainer').node() as Element;\n    const x = parent.scrollLeft + parent.clientWidth / 2;\n    const y = parent.scrollTop + parent.clientHeight / 2;\n    const scale = zoomTransform(parent).k;\n    select(parent).call(zoom().translateTo, x / scale, y / scale);\n}\n\n/** Loads blob as data URL. */\nfunction loadAsDataUrl(blob: Blob): Promise<string> {\n    const reader = new FileReader();\n    reader.readAsDataURL(blob);\n    return new Promise<string>((resolve, reject) => {\n        reader.onload = (e) => resolve((e.target as FileReader).result as string);\n    });\n}\n\nasync function inlineImage(image: SVGImageElement) {\n    const href = image.href.baseVal;\n    if (!href) {\n        return;\n    }\n    try {\n        const response = await fetch(href);\n        const blob = await response.blob();\n        const dataUrl = await loadAsDataUrl(blob);\n        image.href.baseVal = dataUrl;\n    } catch (e) {\n        console.warn('Failed to load image:', e);\n    }\n}\n\n/**\n * Fetches all images in the SVG and replaces them with inlined images as data\n * URLs. Images are replaced in place. The replacement is done, the returned\n * promise is resolved.\n */\nasync function inlineImages(svg: Element): Promise<void> {\n    const images = Array.from(svg.getElementsByTagName('image'));\n    await Promise.all(images.map(inlineImage));\n}\n\n/** Loads a blob into an image object. */\nfunction loadImage(blob: Blob): Promise<HTMLImageElement> {\n    const image = new Image();\n    image.src = URL.createObjectURL(blob);\n    return new Promise<HTMLImageElement>((resolve, reject) => {\n        image.addEventListener('load', () => resolve(image));\n    });\n}\n\n/** Draw image on a new canvas and return the canvas. */\nfunction drawImageOnCanvas(image: HTMLImageElement) {\n    const canvas = document.createElement('canvas');\n    // Scale image for better quality.\n    canvas.width = image.width * 2;\n    canvas.height = image.height * 2;\n\n    const ctx = canvas.getContext('2d')!;\n    const oldFill = ctx.fillStyle;\n    ctx.fillStyle = 'white';\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n    ctx.fillStyle = oldFill;\n\n    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);\n    return canvas;\n}\n\nfunction canvasToBlob(canvas: HTMLCanvasElement, type: string) {\n    return new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n            if (blob) {\n                resolve(blob);\n            } else {\n                reject();\n            }\n        }, type);\n    });\n}\n\n/** Return a copy of the SVG chart but without scaling and positioning. */\nfunction getStrippedSvg() {\n    const svg = document.getElementById('chartSvg')!.cloneNode(true) as Element;\n\n    svg.removeAttribute('transform');\n    const parent = select('#svgContainer').node() as Element;\n    const scale = zoomTransform(parent).k;\n    svg.setAttribute('width', String(Number(svg.getAttribute('width')) / scale));\n    svg.setAttribute(\n        'height',\n        String(Number(svg.getAttribute('height')) / scale),\n    );\n    svg.querySelector('#chart')!.removeAttribute('transform');\n\n    return svg;\n}\n\nfunction getSvgContents() {\n    return new XMLSerializer().serializeToString(getStrippedSvg());\n}\n\nasync function getSvgContentsWithInlinedImages() {\n    const svg = getStrippedSvg();\n    await inlineImages(svg);\n    return new XMLSerializer().serializeToString(svg);\n}\n\n/** Shows the print dialog to print the currently displayed chart. */\nexport function printChart() {\n    const printWindow = document.createElement('iframe');\n    printWindow.style.position = 'absolute';\n    printWindow.style.top = '-1000px';\n    printWindow.style.left = '-1000px';\n    printWindow.onload = () => {\n        printWindow.contentDocument!.open();\n        printWindow.contentDocument!.write(getSvgContents());\n        printWindow.contentDocument!.close();\n        // Doesn't work on Firefox without the setTimeout.\n        setTimeout(() => {\n            printWindow.contentWindow!.focus();\n            printWindow.contentWindow!.print();\n            printWindow.parentNode!.removeChild(printWindow);\n        }, 500);\n    };\n    document.body.appendChild(printWindow);\n}\n\nexport async function downloadSvg() {\n    const contents = await getSvgContentsWithInlinedImages();\n    const blob = new Blob([contents], {type: 'image/svg+xml'});\n    saveAs(blob, 'topola.svg');\n}\n\nasync function drawOnCanvas(): Promise<HTMLCanvasElement> {\n    const contents = await getSvgContentsWithInlinedImages();\n    const blob = new Blob([contents], {type: 'image/svg+xml'});\n    return drawImageOnCanvas(await loadImage(blob));\n}\n\nexport async function downloadPng() {\n    const canvas = await drawOnCanvas();\n    const blob = await canvasToBlob(canvas, 'image/png');\n    saveAs(blob, 'topola.png');\n}\n\nexport async function downloadPdf() {\n    // Lazy load jspdf.\n    const {default: jspdf} = await import('jspdf');\n    const canvas = await drawOnCanvas();\n    const doc = new jspdf({\n        orientation: canvas.width > canvas.height ? 'l' : 'p',\n        unit: 'pt',\n        format: [canvas.width, canvas.height],\n    });\n    doc.addImage(canvas, 'PNG', 0, 0, canvas.width, canvas.height, 'NONE');\n    doc.save('topola.pdf');\n}\n\n/** Supported chart types. */\nexport enum ChartType {\n    Hourglass,\n    Relatives,\n    Fancy,\n}\n\nconst chartColors = new Map<ChartColors, TopolaChartColors>([\n    [ChartColors.NO_COLOR, TopolaChartColors.NO_COLOR],\n    [ChartColors.COLOR_BY_GENERATION, TopolaChartColors.COLOR_BY_GENERATION],\n    [ChartColors.COLOR_BY_SEX, TopolaChartColors.COLOR_BY_SEX],\n]);\n\nfunction getChartType(chartType: ChartType) {\n    switch (chartType) {\n        case ChartType.Hourglass:\n            return HourglassChart;\n        case ChartType.Relatives:\n            return RelativesChart;\n        case ChartType.Fancy:\n            return FancyChart;\n        default:\n            // Fall back to hourglass chart.\n            return HourglassChart;\n    }\n}\n\nfunction getRendererType(chartType: ChartType) {\n    switch (chartType) {\n        case ChartType.Fancy:\n            return CircleRenderer;\n        default:\n            // Use DetailedRenderer by default.\n            return DetailedRenderer;\n    }\n}\n\nexport interface ChartProps {\n    data: JsonGedcomData;\n    selection: IndiInfo;\n    chartType: ChartType;\n    onSelection: (indiInfo: IndiInfo) => void;\n    freezeAnimation?: boolean;\n    colors?: ChartColors;\n    hideIds?: Ids;\n    hideSex?: Sex;\n}\n\nclass ChartWrapper {\n    private chart?: ChartHandle;\n    /** Animation is in progress. */\n    private animating = false;\n    /** Rendering is required after the current animation finishes. */\n    private rerenderRequired = false;\n    /** The d3 zoom behavior object. */\n    private zoomBehavior?: ZoomBehavior<Element, any>;\n    /** Props that will be used for rerendering. */\n    private rerenderProps?: ChartProps;\n    private rerenderResetPosition?: boolean;\n\n    zoom(factor: number) {\n        const parent = select('#svgContainer') as Selection<Element, any, any, any>;\n        this.zoomBehavior!.scaleBy(parent, factor);\n    }\n\n    /**\n     * Renders the chart or performs a transition animation to a new state.\n     * If indiInfo is not given, it means that it is the initial render and no\n     * animation is performed.\n     */\n    renderChart(\n        props: ChartProps,\n        intl: IntlShape,\n        args: { initialRender: boolean; resetPosition: boolean } = {\n            initialRender: false,\n            resetPosition: false,\n        },\n    ) {\n        // Wait for animation to finish if animation is in progress.\n        if (!args.initialRender && this.animating) {\n            this.rerenderRequired = true;\n            this.rerenderProps = props;\n            this.rerenderResetPosition = args.resetPosition;\n            return;\n        }\n\n        // Freeze changing selection after initial rendering.\n        if (!args.initialRender && props.freezeAnimation) {\n            return;\n        }\n\n        if (args.initialRender) {\n            (select('#chart').node() as HTMLElement).innerHTML = '';\n            this.chart = createChart({\n                json: props.data,\n                chartType: getChartType(props.chartType),\n                renderer: getRendererType(props.chartType),\n                svgSelector: '#chart',\n                indiCallback: (info) => props.onSelection(info),\n                colors: chartColors.get(props.colors!),\n                animate: true,\n                updateSvgSize: false,\n                locale: intl.locale,\n            });\n        } else {\n            this.chart!.setData(props.data);\n        }\n        const chartInfo = this.chart!.render({\n            startIndi: props.selection.id,\n            baseGeneration: props.selection.generation,\n        });\n        const svg = select('#chartSvg');\n        const parent = select('#svgContainer').node() as Element;\n\n        const scale = zoomTransform(parent).k;\n        const zoomOutFactor = min([\n            1,\n            scale,\n            parent.clientWidth / chartInfo.size[0],\n            parent.clientHeight / chartInfo.size[1],\n        ])!;\n        const extent: [number, number] = [max([0.1, zoomOutFactor])!, 2];\n\n        this.zoomBehavior = zoom()\n            .scaleExtent(extent)\n            .translateExtent([[0, 0], chartInfo.size])\n            .on('zoom', (event) => zoomed(chartInfo.size, event));\n        select(parent).on('scroll', scrolled).call(this.zoomBehavior);\n\n        const scrollTopTween = (scrollTop: number) => {\n            return () => {\n                const i = interpolateNumber(parent.scrollTop, scrollTop);\n                return (t: number) => {\n                    parent.scrollTop = i(t);\n                };\n            };\n        };\n        const scrollLeftTween = (scrollLeft: number) => {\n            return () => {\n                const i = interpolateNumber(parent.scrollLeft, scrollLeft);\n                return (t: number) => {\n                    parent.scrollLeft = i(t);\n                };\n            };\n        };\n\n        const dx = parent.clientWidth / 2 - chartInfo.origin[0] * scale;\n        const dy = parent.clientHeight / 2 - chartInfo.origin[1] * scale;\n        const offsetX = max([\n            0,\n            (parent.clientWidth - chartInfo.size[0] * scale) / 2,\n        ]);\n        const offsetY = max([\n            0,\n            (parent.clientHeight - chartInfo.size[1] * scale) / 2,\n        ]);\n        const svgTransition = svg.transition().delay(200).duration(500);\n        const transition = args.initialRender ? svg : svgTransition;\n        transition\n            .attr('transform', `translate(${offsetX}, ${offsetY})`)\n            .attr('width', chartInfo.size[0] * scale)\n            .attr('height', chartInfo.size[1] * scale);\n        if (args.resetPosition) {\n            if (args.initialRender) {\n                parent.scrollLeft = -dx;\n                parent.scrollTop = -dy;\n            } else {\n                svgTransition\n                    .tween('scrollLeft', scrollLeftTween(-dx))\n                    .tween('scrollTop', scrollTopTween(-dy));\n            }\n        }\n\n        // After the animation is finished, rerender the chart if required.\n        this.animating = true;\n        chartInfo.animationPromise.then(() => {\n            this.animating = false;\n            if (this.rerenderRequired) {\n                this.rerenderRequired = false;\n                // Use `this.rerenderProps` instead of the props in scope because\n                // the props may have been updated in the meantime.\n                this.renderChart(this.rerenderProps!, intl, {\n                    initialRender: false,\n                    resetPosition: !!this.rerenderResetPosition,\n                });\n            }\n        });\n    }\n}\n\nfunction usePrevious<T>(value: T): T | undefined {\n    const ref = useRef<T>();\n    useEffect(() => {\n        ref.current = value;\n    });\n    return ref.current;\n}\n\nexport function Chart(props: ChartProps) {\n    const chartWrapper = useRef(new ChartWrapper());\n    const prevProps = usePrevious(props);\n    const intl = useIntl();\n\n    useEffect(() => {\n        if (prevProps) {\n            const initialRender =\n                props.chartType !== prevProps?.chartType ||\n                props.colors !== prevProps?.colors ||\n                props.hideIds !== prevProps?.hideIds ||\n                props.hideSex !== prevProps?.hideSex;\n            const resetPosition =\n                props.chartType !== prevProps?.chartType ||\n                props.data !== prevProps.data ||\n                props.selection !== prevProps.selection;\n            chartWrapper.current.renderChart(props, intl, {\n                initialRender,\n                resetPosition,\n            });\n        } else {\n            chartWrapper.current.renderChart(props, intl, {\n                initialRender: true,\n                resetPosition: true,\n            });\n        }\n    });\n\n    return (\n        <div id=\"svgContainer\">\n            <Media greaterThanOrEqual=\"large\" className=\"zoom\">\n                <button\n                    className=\"zoom-in\"\n                    onClick={() => chartWrapper.current.zoom(ZOOM_FACTOR)}\n                >\n                    +\n                </button>\n                <button\n                    className=\"zoom-out\"\n                    onClick={() => chartWrapper.current.zoom(1 / ZOOM_FACTOR)}\n                >\n                    \n                </button>\n            </Media>\n            <svg id=\"chartSvg\">\n                <g id=\"chart\"/>\n            </svg>\n        </div>\n    );\n}\n","import * as H from 'history';\nimport * as queryString from 'query-string';\nimport {DataSourceEnum, SourceSelection} from './datasource/data_source';\nimport {Details} from './details/details';\nimport {EmbeddedDataSource, EmbeddedSourceSpec} from './datasource/embedded';\nimport {FormattedMessage, useIntl} from 'react-intl';\nimport {getI18nMessage} from './util/error_i18n';\nimport {IndiInfo} from 'topola';\nimport {Loader, Message, Portal, Tab} from 'semantic-ui-react';\nimport {Media} from './util/media';\nimport {Redirect, Route, Switch} from 'react-router-dom';\nimport {TopBar} from './menu/top_bar';\nimport {TopolaData} from './util/gedcom_util';\nimport {useEffect, useState} from 'react';\nimport {useHistory, useLocation} from 'react-router';\nimport {idToIndiMap} from './util/gedcom_util';\nimport {\n    Chart,\n    ChartType,\n    downloadPdf,\n    downloadPng,\n    downloadSvg,\n} from './chart';\nimport {\n    argsToConfig,\n    Config,\n    ConfigPanel,\n    configToArgs,\n    DEFAULT_CONFIG,\n    Ids,\n    Sex,\n} from './config';\nimport {\n    getSelection,\n    UploadSourceSpec,\n    UrlSourceSpec,\n    GedcomUrlDataSource,\n    UploadedDataSource,\n} from './datasource/load_data';\n\n/**\n * Load GEDCOM URL from REACT_APP_STATIC_URL environment variable.\n *\n * If this environment variable is provided, the viewer is switched to\n * single-tree mode without the option to load other data.\n */\nconst staticUrl = process.env.REACT_APP_STATIC_URL;\n\n/** Shows an error message in the middle of the screen. */\nfunction ErrorMessage(props: { message?: string }) {\n    return (\n        <Message negative className=\"error\">\n            <Message.Header>\n                <FormattedMessage\n                    id=\"error.failed_to_load_file\"\n                    defaultMessage={'Failed to load file'}\n                />\n            </Message.Header>\n            <p>{props.message}</p>\n        </Message>\n    );\n}\n\ninterface ErrorPopupProps {\n    message?: string;\n    open: boolean;\n    onDismiss: () => void;\n}\n\n/**\n * Shows a dismissable error message in the bottom left corner of the screen.\n */\nfunction ErrorPopup(props: ErrorPopupProps) {\n    return (\n        <Portal open={props.open} onClose={props.onDismiss}>\n            <Message negative className=\"errorPopup\" onDismiss={props.onDismiss}>\n                <Message.Header>\n                    <FormattedMessage id=\"error.error\" defaultMessage={'Error'}/>\n                </Message.Header>\n                <p>{props.message}</p>\n            </Message>\n        </Portal>\n    );\n}\n\nenum AppState {\n    INITIAL,\n    LOADING,\n    ERROR,\n    SHOWING_CHART,\n    LOADING_MORE,\n}\n\ntype DataSourceSpec =\n    | UrlSourceSpec\n    | UploadSourceSpec\n    | EmbeddedSourceSpec;\n\n/**\n * Arguments passed to the application, primarily through URL parameters.\n * Non-optional arguments get populated with default values.\n */\ninterface Arguments {\n    sourceSpec?: DataSourceSpec;\n    selection?: IndiInfo;\n    chartType: ChartType;\n    standalone: boolean;\n    freezeAnimation: boolean;\n    showSidePanel: boolean;\n    config: Config;\n}\n\nfunction getParamFromSearch(name: string, search: queryString.ParsedQuery) {\n    const value = search[name];\n    return typeof value === 'string' ? value : undefined;\n}\n\n/**\n * Retrieve arguments passed into the application through the URL and uploaded\n * data.\n */\nfunction getArguments(location: H.Location<any>): Arguments {\n    const search = queryString.parse(location.search);\n    const getParam = (name: string) => getParamFromSearch(name, search);\n\n    const view = getParam('view');\n    const chartTypes = new Map<string | undefined, ChartType>([\n        ['relatives', ChartType.Relatives],\n        ['fancy', ChartType.Fancy],\n    ]);\n\n    const hash = getParam('file');\n    const url = getParam('url');\n    const embedded = getParam('embedded') === 'true'; // False by default.\n    let sourceSpec: DataSourceSpec | undefined = undefined;\n    if (staticUrl) {\n        sourceSpec = {\n            source: DataSourceEnum.GEDCOM_URL,\n            url: staticUrl,\n            handleCors: false,\n        };\n    } else if (hash) {\n        sourceSpec = {\n            source: DataSourceEnum.UPLOADED,\n            hash,\n            gedcom: location.state && location.state.data,\n            images: location.state && location.state.images,\n        };\n    } else if (url) {\n        sourceSpec = {\n            source: DataSourceEnum.GEDCOM_URL,\n            url,\n            handleCors: getParam('handleCors') !== 'false', // True by default.\n        };\n    } else if (embedded) {\n        sourceSpec = {source: DataSourceEnum.EMBEDDED};\n    }\n\n    const indi = getParam('indi');\n    const parsedGen = Number(getParam('gen'));\n    const selection = indi\n        ? {id: indi, generation: !isNaN(parsedGen) ? parsedGen : 0}\n        : undefined;\n\n    return {\n        sourceSpec,\n        selection,\n        // Hourglass is the default view.\n        chartType: chartTypes.get(view) || ChartType.Relatives,\n        showSidePanel: getParam('sidePanel') !== 'false', // True by default.\n        standalone: getParam('standalone') !== 'false' && !embedded && !staticUrl,\n        freezeAnimation: getParam('freeze') === 'true', // False by default\n        config: argsToConfig(search),\n    };\n}\n\nexport function App() {\n    /** State of the application. */\n    const [state, setState] = useState<AppState>(AppState.INITIAL);\n    /** Loaded data. */\n    const [data, setData] = useState<TopolaData>();\n    /** Selected individual. */\n    const [selection, setSelection] = useState<IndiInfo>();\n    /** Error to display. */\n    const [error, setError] = useState<string>();\n    /** Whether the side panel is shown. */\n    const [showSidePanel, setShowSidePanel] = useState(false);\n    /** Whether the app is in standalone mode, i.e. showing 'open file' menus. */\n    const [standalone, setStandalone] = useState(true);\n    /** Type of displayed chart. */\n    const [chartType, setChartType] = useState<ChartType>(ChartType.Hourglass);\n    /** Whether to show the error popup. */\n    const [showErrorPopup, setShowErrorPopup] = useState(false);\n    /** Specification of the source of the data. */\n    const [sourceSpec, setSourceSpec] = useState<DataSourceSpec>();\n    /** Freeze animations after initial chart render. */\n    const [freezeAnimation, setFreezeAnimation] = useState(false);\n    const [config, setConfig] = useState(DEFAULT_CONFIG);\n\n    const intl = useIntl();\n    const history = useHistory();\n    const location = useLocation();\n\n    /** Sets the state with a new individual selection and chart type. */\n    function updateDisplay(newSelection: IndiInfo) {\n        if (\n            !selection ||\n            selection.id !== newSelection.id ||\n            selection!.generation !== newSelection.generation\n        ) {\n            setSelection(newSelection);\n        }\n    }\n\n    function toggleDetails(config: Config, data: TopolaData | undefined) {\n        if (data === undefined) {\n            return;\n        }\n        let shouldHideIds = config.id === Ids.HIDE;\n        let shouldHideSex = config.sex === Sex.HIDE;\n        let indiMap = idToIndiMap(data.chartData);\n        indiMap.forEach((indi) => {\n            indi.hideId = shouldHideIds;\n            indi.hideSex = shouldHideSex;\n        });\n    }\n\n    /** Sets error message after data load failure. */\n    function setErrorMessage(message: string) {\n        setError(message);\n        setState(AppState.ERROR);\n    }\n\n    const uploadedDataSource = new UploadedDataSource();\n    const gedcomUrlDataSource = new GedcomUrlDataSource();\n    const embeddedDataSource = new EmbeddedDataSource();\n\n    function isNewData(newSourceSpec: DataSourceSpec, newSelection?: IndiInfo) {\n        if (!sourceSpec || sourceSpec.source !== newSourceSpec.source) {\n            // New data source means new data.\n            return true;\n        }\n        const newSource = {spec: newSourceSpec, selection: newSelection};\n        const oldSource = {\n            spec: sourceSpec,\n            selection: selection,\n        };\n        switch (newSource.spec.source) {\n            case DataSourceEnum.UPLOADED:\n                return uploadedDataSource.isNewData(\n                    newSource as SourceSelection<UploadSourceSpec>,\n                    oldSource as SourceSelection<UploadSourceSpec>,\n                    data,\n                );\n            case DataSourceEnum.GEDCOM_URL:\n                return gedcomUrlDataSource.isNewData(\n                    newSource as SourceSelection<UrlSourceSpec>,\n                    oldSource as SourceSelection<UrlSourceSpec>,\n                    data,\n                );\n            case DataSourceEnum.EMBEDDED:\n                return embeddedDataSource.isNewData(\n                    newSource as SourceSelection<EmbeddedSourceSpec>,\n                    oldSource as SourceSelection<EmbeddedSourceSpec>,\n                    data,\n                );\n        }\n    }\n\n    function loadData(newSourceSpec: DataSourceSpec, newSelection?: IndiInfo) {\n        switch (newSourceSpec.source) {\n            case DataSourceEnum.UPLOADED:\n                return uploadedDataSource.loadData({\n                    spec: newSourceSpec,\n                    selection: newSelection,\n                });\n            case DataSourceEnum.GEDCOM_URL:\n                return gedcomUrlDataSource.loadData({\n                    spec: newSourceSpec,\n                    selection: newSelection,\n                });\n            case DataSourceEnum.EMBEDDED:\n                return embeddedDataSource.loadData({\n                    spec: newSourceSpec,\n                    selection: newSelection,\n                });\n        }\n    }\n\n    useEffect(() => {\n        const rootElement = document.getElementById('root');\n        if (location.pathname === '/') {\n            // @ts-ignore\n            rootElement.classList.add('bgLogo');\n        } else {\n            // @ts-ignore\n            rootElement.classList.remove('bgLogo');\n        }\n\n        (async () => {\n            if (location.pathname !== '/view') {\n                if (state !== AppState.INITIAL) {\n                    setState(AppState.INITIAL);\n                }\n                return;\n            }\n\n            const args = getArguments(location);\n            if (!args.sourceSpec) {\n                history.replace({pathname: '/'});\n                return;\n            }\n\n            if (\n                state === AppState.INITIAL || isNewData(args.sourceSpec, args.selection)\n            ) {\n                // Set loading state.\n                setState(AppState.LOADING);\n                // Set state from URL parameters.\n                setSourceSpec(args.sourceSpec);\n                setSelection(args.selection);\n                setStandalone(args.standalone);\n                setChartType(args.chartType);\n                setFreezeAnimation(args.freezeAnimation);\n                setConfig(args.config);\n                try {\n                    const data = await loadData(args.sourceSpec, args.selection);\n                    // Set state with data.\n                    setData(data);\n                    toggleDetails(args.config, data);\n                    setShowSidePanel(args.showSidePanel);\n                    setState(AppState.SHOWING_CHART);\n                } catch (error: any) {\n                    setErrorMessage(getI18nMessage(error, intl));\n                }\n            } else if (\n                state === AppState.SHOWING_CHART || state === AppState.LOADING_MORE\n            ) {\n                // Update selection if it has changed in the URL.\n                setChartType(args.chartType);\n                setState(AppState.SHOWING_CHART);\n                updateDisplay(args.selection!);\n            }\n        })();\n    });\n\n    function updateUrl(args: queryString.ParsedQuery<any>) {\n        const search = queryString.parse(location.search);\n        for (const key in args) {\n            search[key] = args[key];\n        }\n        location.search = queryString.stringify(search);\n        history.push(location);\n    }\n\n    /**\n     * Called when the user clicks an individual box in the chart.\n     * Updates the browser URL.\n     */\n    function onSelection(selection: IndiInfo) {\n        updateUrl({\n            indi: selection.id,\n            gen: selection.generation,\n        });\n    }\n\n    function displayErrorPopup(message: string) {\n        setShowErrorPopup(true);\n        setError(message);\n    }\n\n    async function onDownloadPdf() {\n        // analyticsEvent('download_pdf');\n        try {\n            await downloadPdf();\n        } catch (e) {\n            displayErrorPopup(\n                intl.formatMessage({\n                    id: 'error.failed_pdf',\n                    defaultMessage:\n                        'Failed to generate PDF file.' +\n                        ' Please try with a smaller diagram or download an SVG file.',\n                }),\n            );\n        }\n    }\n\n    async function onDownloadPng() {\n        // analyticsEvent('download_png');\n        try {\n            await downloadPng();\n        } catch (e) {\n            displayErrorPopup(\n                intl.formatMessage({\n                    id: 'error.failed_png',\n                    defaultMessage:'Failed to generate PNG file. Please try with a smaller diagram or download an SVG file.'\n                }),\n            );\n        }\n    }\n\n    function onDownloadSvg() {\n        downloadSvg();\n    }\n\n    function onDismissErrorPopup() {\n        setShowErrorPopup(false);\n    }\n\n    function renderMainArea() {\n        switch (state) {\n            case AppState.SHOWING_CHART:\n            case AppState.LOADING_MORE:\n                const updatedSelection = getSelection(data!.chartData, selection);\n                const sidePanelTabs = [\n                    {\n                        menuItem: intl.formatMessage({\n                            id: 'tab.info',\n                            defaultMessage: 'Info',\n                        }),\n                        render: () => (\n                            <Details gedcom={data!.gedcom} indi={updatedSelection.id}/>\n                        ),\n                    },\n                    {\n                        menuItem: intl.formatMessage({\n                            id: 'tab.settings',\n                            defaultMessage: 'Settings',\n                        }),\n                        render: () => (\n                            <ConfigPanel\n                                config={config}\n                                onChange={(config) => {\n                                    setConfig(config);\n                                    toggleDetails(config, data);\n                                    updateUrl(configToArgs(config));\n                                }}\n                            />\n                        ),\n                    },\n                ];\n                return (\n                    <div id=\"content\">\n                        <ErrorPopup\n                            open={showErrorPopup}\n                            message={error}\n                            onDismiss={onDismissErrorPopup}\n                        />\n                        {state === AppState.LOADING_MORE ? (\n                            <Loader active size=\"small\" className=\"loading-more\"/>\n                        ) : null}\n                        <Chart\n                            data={data!.chartData}\n                            selection={updatedSelection}\n                            chartType={chartType}\n                            onSelection={onSelection}\n                            freezeAnimation={freezeAnimation}\n                            colors={config.color}\n                            hideIds={config.id}\n                            hideSex={config.sex}\n                        />\n                        {showSidePanel ? (\n                            <Media greaterThanOrEqual=\"large\" className=\"sidePanel\">\n                                <Tab panes={sidePanelTabs}/>\n                            </Media>\n                        ) : null}\n                    </div>\n                );\n            case AppState.ERROR:\n                return <ErrorMessage message={error!}/>;\n            case AppState.INITIAL:\n            case AppState.LOADING:\n                return <Loader active size=\"large\"/>;\n        }\n    }\n\n    return (\n        <>\n            <Route\n                render={() => (\n                    <TopBar\n                        data={data?.chartData}\n                        allowAllRelativesChart={true}\n                        showingChart={\n                            history.location.pathname === '/view' &&\n                            (state === AppState.SHOWING_CHART || state === AppState.LOADING_MORE)\n                        }\n                        standalone={standalone}\n                        eventHandlers={{\n                            onSelection,\n                            onDownloadPdf,\n                            onDownloadPng,\n                            onDownloadSvg,\n                        }}\n                    />\n                )}\n            />\n            {staticUrl ? (\n                <Switch>\n                    <Route exact path=\"/view\" render={renderMainArea}/>\n                    <Redirect to={'/view'}/>\n                </Switch>\n            ) : (\n                <Switch>\n                    <Route exact path=\"/view\" render={renderMainArea}/>\n                    <Redirect to={'/'}/>\n                </Switch>\n            )}\n        </>\n    );\n}\n\n","import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport messages_cs from './translations/cs.json';\nimport messages_de from './translations/de.json';\nimport messages_fr from './translations/fr.json';\nimport messages_it from './translations/it.json';\nimport messages_es from './translations/es.json';\nimport messages_pl from './translations/pl.json';\nimport messages_ru from './translations/ru.json';\nimport {App} from './app';\nimport {detect} from 'detect-browser';\nimport {HashRouter as Router, Route} from 'react-router-dom';\nimport {IntlProvider} from 'react-intl';\nimport {MediaContextProvider, mediaStyles} from './util/media';\nimport './index.css';\nimport 'semantic-ui-css/semantic.min.css';\nimport 'canvas-toBlob';\n\nconst messages = {\n    cs: messages_cs,\n    de: messages_de,\n    fr: messages_fr,\n    it: messages_it,\n    es: messages_es,\n    pl: messages_pl,\n    ru: messages_ru,\n};\nconst language = navigator.language && navigator.language.split(/[-_]/)[0];\nconst browser = detect();\n\nif (browser && browser.name === 'ie') {\n    ReactDOM.render(\n        <p>Genealogy Viewer does not support Internet Explorer. Please try a different (modern) browser.</p>,\n        document.querySelector('#root'),\n    );\n} else {\n    ReactDOM.render(\n        <IntlProvider locale={language} messages={messages[language]}>\n            <MediaContextProvider>\n                <style>{mediaStyles}</style>\n                <Router>\n                    <Route component={App}/>\n                </Router>\n            </MediaContextProvider>\n        </IntlProvider>,\n        document.querySelector('#root'),\n    );\n}\n","import {convertGedcom, getSoftware, TopolaData} from '../util/gedcom_util';\nimport {DataSource, DataSourceEnum, SourceSelection} from './data_source';\nimport {IndiInfo, JsonGedcomData} from 'topola';\nimport {TopolaError} from '../util/error';\nimport AdmZip from 'adm-zip';\n\n/**\n * Returns a valid IndiInfo object, either with the given indi and generation\n * or with an individual taken from the data and generation 0.\n */\nexport function getSelection(\n    data: JsonGedcomData,\n    selection?: IndiInfo,\n): IndiInfo {\n    // If ID is not given or it doesn't exist in the data, use the first ID in\n    // the data.\n    const id =\n        selection && data.indis.some((i) => i.id === selection.id)\n            ? selection.id\n            : data.indis[0].id;\n    return {id, generation: selection?.generation || 0};\n}\n\nfunction prepareData(\n    gedcom: string,\n    cacheId: string,\n    images?: Map<string, string>,\n): TopolaData {\n    const data = convertGedcom(gedcom, images || new Map());\n    const serializedData = JSON.stringify(data);\n    try {\n        sessionStorage.setItem(cacheId, serializedData);\n    } catch (e) {\n        console.warn('Failed to store data in session storage: ' + e);\n    }\n    return data;\n}\n\nasync function loadGedzip(\n    blob: Blob,\n): Promise<{ gedcom: string; images: Map<string, string> }> {\n    const zip = new AdmZip(Buffer.from(await blob.arrayBuffer()));\n    const entries = zip.getEntries();\n\n    let gedcom = undefined;\n    const images = new Map<string, string>();\n    for (const entry of entries) {\n        if (entry.entryName.endsWith('.ged')) {\n            if (gedcom) {\n                console.warn('Multiple GEDCOM files found in zip archive.');\n            } else {\n                gedcom = entry.getData().toString();\n            }\n        } else {\n            // Save image for later.\n            images.set(\n                entry.entryName,\n                URL.createObjectURL(new Blob([entry.getData()])),\n            );\n        }\n    }\n    if (!gedcom) {\n        throw new Error('GEDCOM file not found in zip archive.');\n    }\n    return {gedcom, images};\n}\n\nexport async function loadFile(\n    blob: Blob,\n): Promise<{ gedcom: string; images: Map<string, string> }> {\n    const fileHeader = await blob.slice(0, 2).text();\n    if (fileHeader === 'PK') {\n        return loadGedzip(blob);\n    }\n    return {gedcom: await blob.text(), images: new Map()};\n}\n\n/** Fetches data from the given URL. Uses cors-anywhere if handleCors is true. */\nexport async function loadFromUrl(\n    url: string,\n    handleCors: boolean,\n): Promise<TopolaData> {\n    try {\n        const cachedData = sessionStorage.getItem(url);\n        if (cachedData) {\n            return JSON.parse(cachedData);\n        }\n    } catch (e) {\n        console.warn('Failed to load data from session storage: ' + e);\n    }\n\n    const driveUrlMatch1 = url.match(\n        /https:\\/\\/drive\\.google\\.com\\/file\\/d\\/(.*)\\/.*/,\n    );\n    if (driveUrlMatch1) {\n        url = `https://drive.google.com/uc?id=${driveUrlMatch1[1]}&export=download`;\n    }\n    const driveUrlMatch2 = url.match(\n        /https:\\/\\/drive\\.google\\.com\\/open\\?id=([^&]*)&?.*/,\n    );\n    if (driveUrlMatch2) {\n        url = `https://drive.google.com/uc?id=${driveUrlMatch2[1]}&export=download`;\n    }\n\n    const urlToFetch = handleCors ? 'https://topolaproxy.bieda.it/' + url : url;\n\n    const response = await window.fetch(urlToFetch);\n    if (response.status !== 200) {\n        throw new Error(response.statusText);\n    }\n\n    const {gedcom, images} = await loadFile(await response.blob());\n    return prepareData(gedcom, url, images);\n}\n\n/** Loads data from the given GEDCOM file contents. */\nexport async function loadGedcom(\n    hash: string,\n    gedcom?: string,\n    images?: Map<string, string>,\n): Promise<TopolaData> {\n    try {\n        const cachedData = sessionStorage.getItem(hash);\n        if (cachedData) {\n            return JSON.parse(cachedData);\n        }\n    } catch (e) {\n        console.warn('Failed to load data from session storage: ' + e);\n    }\n    if (!gedcom) {\n        throw new TopolaError(\n            'ERROR_LOADING_UPLOADED_FILE',\n            'Error loading data. Please upload your file again.',\n        );\n    }\n    return prepareData(gedcom, hash, images);\n}\n\nexport interface UploadSourceSpec {\n    source: DataSourceEnum.UPLOADED;\n    gedcom?: string;\n    /** Hash of the GEDCOM contents. */\n    hash: string;\n    images?: Map<string, string>;\n}\n\n/** Files opened from the local computer. */\nexport class UploadedDataSource implements DataSource<UploadSourceSpec> {\n    // isNewData(args: Arguments, state: State): boolean {\n    isNewData(\n        newSource: SourceSelection<UploadSourceSpec>,\n        oldSource: SourceSelection<UploadSourceSpec>,\n        data?: TopolaData,\n    ): boolean {\n        return newSource.spec.hash !== oldSource.spec.hash;\n    }\n\n    async loadData(\n        source: SourceSelection<UploadSourceSpec>,\n    ): Promise<TopolaData> {\n        try {\n            const data = await loadGedcom(\n                source.spec.hash,\n                source.spec.gedcom,\n                source.spec.images,\n            );\n            const software = getSoftware(data.gedcom.head);\n            return data;\n        } catch (error) {\n            throw error;\n        }\n    }\n}\n\nexport interface UrlSourceSpec {\n    source: DataSourceEnum.GEDCOM_URL;\n    /** URL of the data that is loaded or is being loaded. */\n    url: string;\n    handleCors: boolean;\n}\n\n/** GEDCOM file loaded by pointing to a URL. */\nexport class GedcomUrlDataSource implements DataSource<UrlSourceSpec> {\n    isNewData(\n        newSource: SourceSelection<UrlSourceSpec>,\n        oldSource: SourceSelection<UrlSourceSpec>,\n        data?: TopolaData,\n    ): boolean {\n        return newSource.spec.url !== oldSource.spec.url;\n    }\n\n    async loadData(source: SourceSelection<UrlSourceSpec>): Promise<TopolaData> {\n        try {\n            return await loadFromUrl(source.spec.url, source.spec.handleCors);\n        } catch (error) {\n            throw error;\n        }\n    }\n}\n"],"sourceRoot":""}